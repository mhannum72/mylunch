var DISQUS=function(d){var f=d.DISQUS||{};f.AssertionError=function(c){this.message=c};f.AssertionError.prototype.toString=function(){return"Assertion Error: "+(this.message||"[no message]")};f.assert=function(c,g,e){if(!c)if(e)d.console&&d.console.log("DISQUS assertion failed: "+g);else throw new f.AssertionError(g);};var g=[];f.define=function(c,m){typeof c==="function"&&(m=c,c="");for(var e=c.split("."),p=e.shift(),a=f,i=(m||function(){return{}}).call({overwrites:function(a){a.__overwrites__=!0;
return a}},d);p;)a=a[p]?a[p]:a[p]={},p=e.shift();for(var l in i)i.hasOwnProperty(l)&&(!i.__overwrites__&&a[l]!==null&&f.assert(!a.hasOwnProperty(l),"Unsafe attempt to redefine existing module: "+l,!0),a[l]=i[l],g.push(function(a,i){return function(){delete a[i]}}(a,l)));return a};f.use=function(c){return f.define(c)};f.cleanup=function(){for(var c=0;c<g.length;c++)g[c]()};return f}(window);
DISQUS.define(function(d,f){var g=d.DISQUS,c=d.document,m=c.getElementsByTagName("head")[0]||c.body,e={running:!1,timer:null,queue:[]};g.defer=function(c,a){function i(){var a=e.queue;if(a.length===0)e.running=!1,clearInterval(e.timer);for(var i=0,c;c=a[i];i++)c[0]()&&(a.splice(i--,1),c[1]())}e.queue.push([c,a]);i();if(!e.running)e.running=!0,e.timer=setInterval(i,100)};g.each=function(c,a){var i=c.length,l=Array.prototype.forEach;if(isNaN(i))for(var k in c)c.hasOwnProperty(k)&&a(c[k],k,c);else if(l)l.call(c,
a);else for(l=0;l<i;l++)a(c[l],l,c)};g.extend=function(c){g.each(Array.prototype.slice.call(arguments,1),function(a){for(var i in a)c[i]=a[i]});return c};g.serializeArgs=function(c){var a=[];g.each(c,function(i,c){i!==f&&a.push(c+(i!==null?"="+encodeURIComponent(i):""))});return a.join("&")};g.isString=function(c){return Object.prototype.toString.call(c)==="[object String]"};g.serialize=function(c,a,i){a&&(c+=~c.indexOf("?")?c.charAt(c.length-1)=="&"?"":"&":"?",c+=g.serializeArgs(a));if(i)return a=
{},a[(new Date).getTime()]=null,g.serialize(c,a);a=c.length;return c.charAt(a-1)=="&"?c.slice(0,a-1):c};g.require=function(e,a,i,l,k){function d(a){if(a.type=="load"||/^(complete|loaded)$/.test(a.target.readyState))l&&l(),n&&clearTimeout(n),g.bean.remove(a.target,j,d)}var f=c.createElement("script"),j=f.addEventListener?"load":"readystatechange",n=null;f.src=g.serialize(e,a,i);f.async=!0;f.charset="UTF-8";(l||k)&&g.bean.add(f,j,d);k&&(n=setTimeout(function(){k()},2E4));m.appendChild(f);return g};
g.requireStylesheet=function(e,a,i){var l=c.createElement("link");l.rel="stylesheet";l.type="text/css";l.href=g.serialize(e,a,i);m.appendChild(l);return g};g.requireSet=function(c,a,i){var e=c.length;g.each(c,function(c){g.require(c,{},a,function(){--e===0&&i()})})};g.injectCss=function(e){var a=c.createElement("style");a.setAttribute("type","text/css");e=e.replace(/\}/g,"}\n");d.location.href.match(/^https/)&&(e=e.replace(/http:\/\//g,"https://"));a.styleSheet?a.styleSheet.cssText=e:a.appendChild(c.createTextNode(e));
m.appendChild(a)}});
DISQUS.define("JSON",function(){function d(a){return a<10?"0"+a:a}function f(a){p.lastIndex=0;return p.test(a)?'"'+a.replace(p,function(a){var c=l[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function g(c,e){var l,d,j,p,r=a,o,q=e[c];q&&typeof q==="object"&&typeof q.toJSON==="function"&&!m&&(q=q.toJSON(c));typeof k==="function"&&(q=k.call(e,c,q));switch(typeof q){case "string":return f(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);
case "object":if(!q)return"null";a+=i;o=[];if(Object.prototype.toString.apply(q)==="[object Array]"){p=q.length;for(l=0;l<p;l+=1)o[l]=g(l,q)||"null";j=o.length===0?"[]":a?"[\n"+a+o.join(",\n"+a)+"\n"+r+"]":"["+o.join(",")+"]";a=r;return j}if(k&&typeof k==="object"){p=k.length;for(l=0;l<p;l+=1)d=k[l],typeof d==="string"&&(j=g(d,q))&&o.push(f(d)+(a?": ":":")+j)}else for(d in q)Object.hasOwnProperty.call(q,d)&&(j=g(d,q))&&o.push(f(d)+(a?": ":":")+j);j=o.length===0?"{}":a?"{\n"+a+o.join(",\n"+a)+"\n"+
r+"}":"{"+o.join(",")+"}";a=r;return j}}var c={},m=!1;if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+d(this.getUTCMonth()+1)+"-"+d(this.getUTCDate())+"T"+d(this.getUTCHours())+":"+d(this.getUTCMinutes())+":"+d(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
p=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,a,i,l={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;c.stringify=function(c,e,l){var d;i=a="";if(typeof l==="number")for(d=0;d<l;d+=1)i+=" ";else typeof l==="string"&&(i=l);if((k=e)&&typeof e!=="function"&&(typeof e!=="object"||typeof e.length!=="number"))throw Error("JSON.stringify");return g("",{"":c})};c.parse=function(a,c){function i(a,
e){var k,l,q=a[e];if(q&&typeof q==="object")for(k in q)Object.hasOwnProperty.call(q,k)&&(l=i(q,k),l!==void 0?q[k]=l:delete q[k]);return c.call(a,e,q)}var k,a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return k=eval("("+a+")"),
typeof c==="function"?i({"":k},""):k;throw new SyntaxError("JSON.parse");};var r={a:[1,2,3]},o,j;if(Object.toJSON&&Object.toJSON(r).replace(/\s/g,"")==='{"a":[1,2,3]}')o=Object.toJSON;typeof String.prototype.evalJSON==="function"&&(r='{"a":[1,2,3]}'.evalJSON(),r.a&&r.a.length===3&&r.a[2]===3&&(j=function(a){return a.evalJSON()}));(function(){var a=[1,2,3];typeof a.toJSON==="function"&&(a=a.toJSON(),m=!(a&&a.length===3&&a[2]===3))})();if(m||!o||!j)return{stringify:c.stringify,parse:c.parse};return{stringify:o,
parse:j}});
DISQUS.define("Bus",function(){function d(c){c=c.split("/");return c[0]+"//"+c[2]}var f=DISQUS.use("JSON"),g=window.location.hash.slice(1),c=window.opener||window.parent,m=document.referrer,e={};e.client=d(document.location.href);e.host=m?d(m):e.client;return{origins:e,messageHandler:function(c){var a;try{a=DISQUS.JSON.parse(c.data)}catch(i){return}if(!a.name||!(a.name[0]==="!"&&c.origin!==e.client))switch(a.scope){case "client":DISQUS.Bus.trigger(a.name,a.data)}},postMessage:function(e){e.sender=g;
e=f.stringify(e);c.postMessage(e,"*")},sendHostMessage:function(c,a){a=a||[];DISQUS.Bus.postMessage({scope:"host",name:c,data:a})},sendGlobalMessage:function(c,a){a=a||[];DISQUS.Bus.postMessage({scope:"global",name:c,data:a})}}});_.extend(DISQUS.Bus,Backbone.Events);
$(document).ready(function(){var d=window.addEventListener?window.addEventListener:window.attachEvent,f=window.addEventListener?"message":"onmessage";if(!d)throw Error("No event support.");d(f,DISQUS.Bus.messageHandler,!1);window.onunload=function(){DISQUS.Bus.sendHostMessage("die")}});
DISQUS.define(function(d,f){var g={blocks:{},ISO_8601:"YYYY-MM-DDTHH:mm:ssZ",apiKey:"E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F",bean:require("bean"),debug:!1,browser:{mobile:/iPhone|Android|iPod|iPad|webOS|Mobile Safari|Windows Phone|BlackBerry|Opera Mini|IEMobile/i.test(navigator.userAgent)},modules:{},strings:{translations:{}}};g.strings.get=_.bind(function(c){var d=this.translations[c];return d!==f?d:c},g.strings);g.interpolate=function(c,d){return c.replace(/%\(\w+\)s/g,
function(e){var e=e.slice(2,-2),g="";e in d?g=d[e]!==f&&d[e]!==null?d[e].toString():"":DISQUS.logError&&DISQUS.logError("Key `"+e+"` not found in context for: ",c);return g})};d.gettext=_.bind(g.strings.get,g.strings);g.templateGlobals={urls:DISQUS.use("urls"),sso:null,gettext:g.strings.get};g.renderBlock=function(c,d){return Handlebars.partials[c](d||{},{data:g.templateGlobals})};g.assureOffset=function(c){return c.indexOf("+")>=0?c:c+"+00:00"};return g});
DISQUS.define("urls",function(){var d=DISQUS.debug?"/js/src/embed/next/vglnk.js":"/build/next/alfie.js",f=encodeURIComponent(document.referrer),g={root:"http://disqus.com",media:"http://mediacdn.disqus.com/1367873877",translations:"http://mediacdn.disqus.com/1367873877/build/lang",loading:"http://mediacdn.disqus.com/1367873877/html/simple-loading.html",realertime:"//realtime.services.disqus.com",juggler:"http://juggler.services.disqus.com",login:"https://disqus.com/next/login/",api:"http://disqus.com/api/3.0/",
apiSecure:"https://disqus.com/api/3.0/",logout:"http://disqus.com/logout/?redirect="+f,editProfile:"http://disqus.com/account/",verifyEmail:"https://disqus.com/next/verify/",authorize:"https://disqus.com/api/oauth/2.0/authorize/",moderate:"http://disqus.com/admin/moderate/",oauth:{twitter:"http://disqus.com/_ax/twitter/begin/",google:"http://disqus.com/_ax/google/begin/",facebook:"http://disqus.com/_ax/facebook/begin/"},avatar:{generic:"http://mediacdn.disqus.com/1367873877/img/next/noavatar92.png"},
linkAffiliatorClient:"http://mediacdn.disqus.com/1367873877"+d};window.location.protocol==="https:"&&(g=_.extend(g,{root:"https://disqus.com",media:"https://securecdn.disqus.com/1367873877",translations:"https://securecdn.disqus.com/1367873877/build/lang",loading:"https://securecdn.disqus.com/1367873877/html/simple-loading.html",api:g.apiSecure,logout:"https://disqus.com/logout/?redirect="+f,editProfile:"https://disqus.com/account/",moderate:"https://disqus.com/admin/moderate/",oauth:{twitter:"https://disqus.com/_ax/twitter/begin/",
google:"https://disqus.com/_ax/google/begin/",facebook:"http://disqus.com/_ax/facebook/begin/"},avatar:{generic:"https://securecdn.disqus.com/1367873877/img/next/noavatar92.png"},linkAffiliatorClient:"https://securecdn.disqus.com/1367873877"+d}));return g});
DISQUS.define("api",function(){function d(c){function d(i){var f=i.originalEvent.origin;DISQUS.urls.apiSecure.slice(0,f.length)===f&&(i=DISQUS.JSON.parse(i.originalEvent.data),i.requestId===e&&(f=i.code===0?c.success:c.error,delete i.requestId,(f||function(){})(i),document.body.removeChild(l),document.body.removeChild(a),$(window).off("message",d)))}var e=_.uniqueId("ft_"),f=document.createElement("div"),a=document.createElement("form"),i="frame_"+e,l;f.innerHTML='<iframe name="'+i+'"></iframe>';
l=f.childNodes[0];a.target=i;a.action=c.url.replace(".json",".pm");a.method=c.method||"GET";c.data=_.extend(c.data,{callback:e,referrer:document.referrer});_.each(c.data,function(c,i){c===!0?c=[1]:c===!1?c=[0]:c===null?c=[""]:_.isArray(c)||(c=[c]);_.each(c,function(c){var e=document.createElement("input");e.type="hidden";e.name=i;e.value=c;a.appendChild(e)})});$(window).on("message",d);document.body.appendChild(l);document.body.appendChild(a);a.submit()}function f(c){c=_.defaults(c,g);c.data=c.data||
{};c.data.api_key=DISQUS.apiKey;return $.ajax(c)}var g={};return{defaults:function(c){var d,e,f;for(d in c)e=c[d],f=g[d],_.isObject(e)&&_.isObject(f)?_.extend(f,e):g[d]=e},headers:function(c){c=_.extend({},g.headers,c);g.headers=_.pick(c,_.map(c,function(c,e){if(c)return e}));return g.headers},getURL:function(c,d){d=d||{};if(d.secure||window.location.protocol==="https:")return DISQUS.urls.apiSecure+c;return DISQUS.urls.api+c},ajax:f,call:function(c,g){g=g||{};g.url=DISQUS.api.getURL(c,{secure:g.secure});
g.data=_.extend(g.data||{},{api_key:DISQUS.apiKey});return(g.secure?d:f)(g)}}});(function(d){d.ajax=function(d){d.method=d.type;d.type=d.dataType;delete d.dataType;return DISQUS.api.ajax(d)};d.Collection.prototype.parse=function(d){return d.response}})(Backbone);
DISQUS.define("ga",function(d){var f,g=function(c){f?f(c):d._gaq.push(c)},c={component:1,"package":2,forum:3,version:4,userType:5};return{setCaller:function(c){f=c},setAccount:function(c){g(["_setAccount",c])},setCustomVar:function(d,e){g(["_setCustomVar",c[d],d,e])},trackPageview:function(){g(["_trackPageview"])},trackEvent:function(c,d,f){g(["_trackEvent",d,c,f,1])},setDomainName:function(c){g(["_setDomainName",c])}}});
DISQUS.define("juggler",function(d){var f=(new Date).getTime().toString(10)+Math.floor(Math.random()*1E6).toString(10),g={},c=function(c){g[c]=this;this._emit=null;this.meta={};this.allowedOverwrites=["thread","forum","forum_id","user_id"];this.reservedKeys=this.allowedOverwrites.slice().concat(["imp","event","prev_imp"]);this.preloadBuffer=[]};DISQUS.extend(c.prototype,{disable:function(){this._emit=function(){};this.preloadBuffer=[]},copySettings:function(){return DISQUS.extend({},this.settings,
this.meta)},overwrite:function(c){for(var d=0,f=this.allowedOverwrites.length;d<f;d++){var a=this.allowedOverwrites[d];c.hasOwnProperty(a)&&(this.meta[a]=c[a])}},load:function(c){var e=this;e.settings=c;e.url=c.url;if(c.disable)return void e.disable();if(d.location.protocol==="https:"){if(c.disableSSL)return void e.disable();e.url=e.url.replace("http:","https:")}DISQUS.each(e.allowedOverwrites,function(d){e.meta[d]=c[d]});e.meta.imp=f;e.meta.prev_imp=DISQUS.cookies.read("__jid");DISQUS.cookies.create("__jid",
f,{expiresIn:18E5});e._emit=function(c){DISQUS.each(e.meta,function(a,d){c[d]=e.meta[d]});DISQUS.require(e.url,c,!1)};DISQUS.each(e.preloadBuffer,function(c){e._emit(c)})},emit:function(c,d){d=DISQUS.extend({},d);DISQUS.each(this.reservedKeys,function(c){if(d[c]!=null)throw"Error: cannot overwrite event context '"+c+"'";});d.event=c;this._emit==null?this.preloadBuffer.push(d):this._emit(d)}});return{client:function(d,e){return g[d]||e&&new c(d)},impId:f}});
DISQUS.define("next.intelligence",function(d){function f(c,d){function e(a){if(!(a instanceof DISQUS.next.models.User)&&!(a instanceof DISQUS.next.models.AnonUser))throw Error("determineUserType(user) needs an instance of User/Anonuser");return a.has("remote")?a.get("remote").domain:a.id?"disqus":n?"guest":"not_logged_in"}function f(a){if(d.switches.length>0)a(d.switches);else d.switches.on("reset",function A(){d.switches.off("reset",A);a(d.switches)})}var a=d.initialData;if(_.isObject(a)&&!_.isEmpty(a)){var i=
DISQUS.ga.setCustomVar,l=DISQUS.ga.trackPageview,k=function(a){DISQUS.ga.trackEvent(a,r,o)},r="next",o=a.forum.id,j="not_logged_in",n=!1,t=a.features.support_preferred?"plus":a.features.support_priority?"pro":a.features.support_vip?"vip":"free";d.session.on("identify",function z(){var n=this;n.off("identify",z);var w=n.user.id;w&&g.overwrite({user_id:w});f(function(d){if(d.enabled("juggler_thread_onReady")){var i={thread_slug:a.thread.slug,user_type:n.user.get("user_type")||"anon",referrer:c.document.referrer,
theme:"next"};g.emit("init_embed",i);d.enabled("dark_jester")&&(d=DISQUS.juggler.client("jester",!0),d.load(_.extend(g.copySettings(),{url:"http://referrer.disqus.com/juggler/event.js"})),d.emit("init_embed",i))}});j=e(n.user);i("component","embed");i("package",t);i("forum",o);i("version",r);i("userType",j);l();d.session.on("change:id",function(a){var c=j;j=e(a);c!=j&&(i("userType",j),k(j=="not_logged_in"||j=="guest"?"logout":"login"))})});f(function(c){g.load({disable:!c.enabled("juggler_enabled"),
url:"http://juggler.services.disqus.com/event.js",disableSSL:c.enabled("next_disable_ssl_juggler"),thread:a.thread.id,forum:a.forum.id,forum_id:a.forum.pk})});DISQUS.each({inViewport:function(){k("view_embed");d.off("inViewport")},"uiAction:createPost":function(a){j=="not_logged_in"&&(j="guest",i("userType",j));n=!0;a.get("parent")!=null?k("post_comment_reply"):k("post_comment")},"uiAction:postUpvote":function(){k("like_comment")},"uiAction:postDownvote":function(){k("dislike_comment")},"uiAction:threadUpvote":function(){k("like_thread")},
"uiAction:postShare":function(a){k("share_comment_"+a)},"uiAction:threadShare":function(a){k("share_thread_"+a)},"uiAction:navigate":function(a){(a={community:"community",dashboard:"mydisqus",profile:"profile",reactions:"reactions"}[a])&&k("open_"+a)},"uiAction:followUser":function(){k("follow_user")},"uiAction:openLogin":function(a){k("open_login_"+a)},"uiAction:finishRegistrationEmbed":function(){k("finish_registration_embed")},"uiAction:finishRegistrationWindow":function(){k("finish_registration_window")},
"uiAction:finishAccountComplete":function(){k("finish_account_complete")}},function(a,c){d.on(c,a)})}}var g=DISQUS.juggler.client("juggler",!0);return{init:function(c){f(d,c)}}});
DISQUS.define("cookies",function(){return{create:function(d,f,g){d=d+"="+f+"; path=/";g.domain&&(d+="; domain=."+g.domain);g.expiresIn&&(f=new Date,f.setTime(f.getTime()+g.expiresIn),d+="; expires="+f.toGMTString());document.cookie=d},read:function(d){d+="=";for(var f=document.cookie.split(";"),g,c=0;c<f.length;c++){for(g=f[c];g.charAt(0)==" ";)g=g.substring(1,g.length);if(g.indexOf(d)===0)return g.substring(d.length,g.length)}return null},erase:function(d,f){var g=new Date;g.setTime(g.getTime()+
-864E5);g=d+"=; path=/;expires="+g.toGMTString();f.domain&&(g+="; domain=."+f.domain);document.cookie=g}}});
DISQUS.define("next.utils",function(){function d(a){function c(a){a=Number(a).toString(16);return a.length==1?"0"+a:a}if(a.substr(0,1)==="#")return a;var d=/.*?rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(a);if(!d||d.length!==4)return"";var a=c(d[1]),e=c(d[2]),d=c(d[3]);return"#"+a+e+d}var f={handler:function(a,c,d){a&&d>=200&&d<300?a():c&&(d<200||d>=300)&&c()},XHR2:function(a,c,d,e){var g=f.handler,j=new XMLHttpRequest;j.open(a,c,!0);j.onreadystatechange=function(){j.readyState===XMLHttpRequest.DONE&&g(d,
e,j.status)};return j},XDR:function(a,c,d,e){if(a!=="GET"&&a!=="POST")return null;var g=f.handler,j=new XDomainRequest;j.open(a,c);j.onload=_.bind(g,window,d,e,200);j.ontimeout=j.onerror=_.bind(g,window,d,e,500);return j}};f.request=function(){return"withCredentials"in new XMLHttpRequest?f.XHR2:window.XDomainRequest?f.XDR:function(){return null}}();var g=RegExp("[\\u0021-\\u002F\\u003A-\\u0040\\u005B-\\u0060\\u007B-\\u007E\\u00A1-\\u00BF\\u2010-\\u2027\\u2030-\\u205E\\u2300-\\u23FF\\u2E00-\\u2E7F\\u3001-\\u303F\\uFE10-\\uFE19\\uFE30-\\uFE4F\\uFE50-\\uFE6B\\uFF01-\\uFF0F\\uFF1A-\\uFF20\\uFF3B-\\uFF40\\uFF5B-\\uFF60\\uFF5F-\\uFF64]+$"),
c={domain:DISQUS.urls.root.split("/")[2],create:function(a,d){DISQUS.cookies.create(a,d,{domain:c.domain,expiresIn:31536E6})},read:DISQUS.cookies.read,erase:function(a){DISQUS.cookies.erase(a,{domain:c.domain})}},m=function(){var a={};return{getItem:function(c){return a.hasOwnProperty(c)?a[c]:null},setItem:function(c,d){a[c]=String(d)},removeItem:function(c){delete a[c]}}}(),e=/^[a-z0-9_.%+\-]+@[0-9a-z.\-]+\.[a-z.]{2,6}$/i,p=function(){function a(){this.state=null;this.queue=[]}_.extend(a.prototype,
{highlight:function(a){this.state===null&&this._load();this.queue.push(a);this.state===2&&this._flush()},_load:function(){var a=this;a.state=1;DISQUS.require("http://mediacdn.disqus.com/1367873877/build/js/highlight.js",{},!1,function(){a.state=2;a._flush()})},_flush:function(){_.chainedDefer(this.queue,function(a){var c=$(a).html();$(a).html(c.replace(/^<br>/,""));hljs.highlightBlock(a)},this)}});return new a}(),a=function(){var a=document.createElement("fakeelement"),c={transition:"transitionend",
OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"},d;for(d in c)if(a.style[d]!==void 0)return c[d];return null}();return{attempt:function(a,c){try{_.bind(a,c||{})()}catch(d){return d}return null},extract:function(a,c){for(var d=c.split("."),e=d.shift();e;){if(d.length===0)return a[e];if(!_.isObject(a[e]))return;a=a[e];e=d.shift()}return a},addStylesheetRules:function(a){function c(){var e=_.find(document.styleSheets,function(a){return(a.ownerNode||a.owningElement).id===
d});if(!e)return void setTimeout(c,50);for(var f=0,g=a.length;f<g;f++){var t=1,u=a[f],r=u[0],m="";Object.prototype.toString.call(u[1][0])==="[object Array]"&&(u=u[1],t=0);for(var p=u.length;t<p;t++){var v=u[t];m+=v[0]+":"+v[1]+(v[2]?" !important":"")+";\n"}e.insertRule?e.insertRule(r+"{"+m+"}",e.cssRules.length):e.addRule(r,m,-1)}}var d="css_"+(new Date).getTime(),e=document.createElement("style");e.id=d;document.getElementsByTagName("head")[0].appendChild(e);window.createPopup||e.appendChild(document.createTextNode(""));
c()},escapeColor:function(a){return d(a).replace(/[^#A-Fa-f0-9]/g,"")},CORS:f,hashStorage:m,cookies:c,niceTruncate:function(a,c){if(a.length<=c)return a;var d=a=a.slice(0,c-1),e=/(^.*\S)\s/.exec(a);e&&(a=e[1]);(e=g.exec(a))&&(a=a.slice(0,a.length-e[0].length));a.length<0.5*d.length&&(a=d);return a+"\u2026"},htmlDecode:function(a){var c=document.createElement("div");c.innerHTML=a;return c.childNodes.length===0?"":c.childNodes[0].nodeValue},isWindowClosed:function(a){if(!a)return!0;try{return a.closed||
a.closed===void 0}catch(c){return!0}},validateEmail:function(a){return e.test(a)},updateURL:function(a,c){var d=document.createElement("a"),c=c||{};d.href=a;c.hostname&&c.hostname.match(/\.$/)&&(c.hostname+=d.hostname);d=_.extend({protocol:d.protocol,hostname:d.hostname,pathname:d.pathname,search:d.search},c);if(!d.pathname.match(/^\//))d.pathname="/"+d.pathname;return d.protocol+"//"+d.hostname+d.pathname+d.search},injectBaseElement:function(a,c){var c=c||document,d=c.getElementsByTagName("base")[0]||
c.createElement("base");d.target="_parent";d.href=a;d.parentNode||(c.head||c.getElementsByTagName("head")[0]).appendChild(d)},syntaxHighlighter:p,transitionEndEvent:a,sendStat:function(a,c){c||(c=1E4);if(Math.random()<=1/c)(new Image).src=DISQUS.serialize(DISQUS.urls.juggler+"/stat.gif",{event:a})}}});
DISQUS.define("next.realtime",function(d){function f(){e.apply(this,arguments);this.marker=this.reqCounter=0;this.interval=1;this._boundOnError=_.bind(this.onError,this);this._boundOnLoad=_.bind(this.onLoad,this);this._boundOnProgress=_.bind(this.onProgress,this)}function g(){e.apply(this,arguments);this.handshakeSuccess=null;this.interval=1;this._boundOnOpen=_.bind(this.onOpen,this);this._boundError=_.bind(this.onError,this);this._boundClose=_.bind(this.onClose,this);this._boundMessage=_.compose(_.bind(this.onMessage,
this),function(a){return JSON.parse(a.data)})}var c=DISQUS.use("next.utils"),m=function(){},e=function(a,c){this.thread=a;this.since=c;this.connection=null;this.paused=!1;this._msgBuffer=[];this._boundOpen=_.bind(this.open,this)};_.extend(e.prototype,Backbone.Events,{getUrl:function(a){var c={};if(this.since)c.since=this.since;_.extend(c,a);return DISQUS.serialize(this.baseUrl+this.thread,c)},onMessage:function(a){var c=a.message_type,d=a.firehose_id;this.lastEventId=d;DISQUS.log("RT: new message:",
c,d);this.trigger(c,{type:c,data:a.message_body,lastEventId:d})},_msgToBuffer:function(){this._msgBuffer.push(_.toArray(arguments))},pause:function(a){if(!this.paused)this.paused=!0,this._trigger=this.trigger,this.trigger=a===!1?m:this._msgToBuffer},resume:function(){if(this.paused){this.paused=!1;this.trigger=this._trigger;for(var a;a=this._msgBuffer.shift();)this.trigger.apply(this,a)}},open:function(){throw Error("Pipe class cannot be used directly.");},close:function(){var a=this.connection;if(!a)return!1;
this.connection=null;return a}});_.extend(f.prototype,e.prototype,{baseUrl:DISQUS.urls.realertime+"/api/2/thread/",onError:function(){if(this.connection)this.connection=null,this.trigger("error",this),this.interval<=120&&(this.interval*=2),c.sendStat("rt_streampipe_error"),DISQUS.logError("RT: Connection error, backing off %s secs",this.interval),_.delay(this._boundOpen,this.interval*1E3)},onLoad:function(){if(this.connection)this.since=this.connection=null,this.trigger("success",this),c.sendStat("rt_streampipe_close"),
_.defer(this._boundOpen)},onProgress:function(){if(this.connection){var a=this.connection.responseText,c=0;if(a&&!(this.marker>=a.length)){for(var a=a.slice(this.marker).split("\n"),d,e,f,g=a.length,j=0;j<g;j++)if(d=a[j],c+=d.length+1,e=d.replace(/^\s+|\s+$/g,"")){try{f=JSON.parse(e)}catch(n){if(j===g-1){c-=d.length+1;break}else{DISQUS.log("RT: unable to parse: ",e,d);continue}}this.onMessage(f)}else DISQUS.log("RT: ignoring empty row...");c>0&&(this.marker+=c-1)}}},open:function(){this.close();var a=
this.connection=c.CORS.request("GET",this.getUrl({bust:++this.reqCounter}),this._boundOnLoad,this._boundOnError);if(!a)return c.sendStat("rt_streampipe_cors_unavail"),void DISQUS.log("RT: Cannot use any cross-domain request tool with StreamPipe. Bailing out.");a.onprogress=this._boundOnProgress;this.connection=a;this.marker=0;try{a.send()}catch(d){this.connection=null,c.sendStat("rt_streampipe_cors_fail"),DISQUS.log("RT: Attempt to send a CORS request failed.")}},close:function(){var a=e.prototype.close.apply(this);
return a&&a.abort()}});_.extend(g.prototype,e.prototype,{baseUrl:(d.location.protocol==="https:"?"wss:":"ws:")+DISQUS.urls.realertime+"/ws/2/thread/",onOpen:function(){DISQUS.log("RT: [Socket] Connection established.");this.handshakeSuccess=!0;this.since=null},onError:function(){if(this.connection)this.connection=null,this.handshakeSuccess?(this.trigger("error"),this.interval<=120&&(this.interval*=2),c.sendStat("rt_socketpipe_error"),DISQUS.logError("RT: Connection error, backing off %s secs",this.interval),
_.delay(this._boundOpen,this.interval*1E3)):(DISQUS.log("RT: [Socket] Error before open, bailing out."),c.sendStat("rt_socketpipe_fail"),this.trigger("fail"))},onClose:function(a){if(this.connection)this.connection=null,a.wasClean?(c.sendStat("rt_socketpipe_clean_close"),DISQUS.log("RT: [Socket] Connection closed. Restarting..."),this.trigger("close",this),this.open()):(c.sendStat("rt_socketpipe_unclean_close"),this.onError())},open:function(){this.close();var a=this.connection=new d.WebSocket(this.getUrl());
a.onopen=this._boundOnOpen;a.onerror=this._boundError;a.onmessage=this._boundMessage;a.onclose=this._boundClose},close:function(){var a=e.prototype.close.apply(this);return a&&a.close()}});var p={_wsSupported:d.WebSocket&&WebSocket.CLOSING===2,initialize:function(a,c,d,e){this.close();this._initArgs=[a,c,d,e];var m=this._wsSupported,o=this.pipe=new (m?g:f)(a,c);_.chain(d).pairs().each(function(a){o.on(a[0],a[1],e)});if(m)o.on("fail",function(){this._wsSupported=!1;o.off();this.initialize.apply(this,
this._initArgs)},this);o.open()},close:function(){if(this.pipe)this.pipe.close(),this.pipe=null}};$(d).on("unload",_.bind(p.close,p));return{Pipe:e,StreamPipe:f,SocketPipe:g,Manager:p}});
DISQUS.define("next.models",function(){function d(a,c,e){var f=d.pool(a),g=c&&c[a.prototype.idAttribute];if(!g)return new a(c,e);d.get(a,g)?f[g].set(c):f[g]=new a(c,e);return f[g]}var f=DISQUS.use("next.collections"),g=DISQUS.use("next.utils"),c=DISQUS.strings.get;d.pool={};d.pool=function(a){a=d.pool[a.__type__];if(!a)throw Error("Model not registered. Use UniqueModel.addType");return a};d.get=function(a,c){return d.pool(a)[c]};d.addType=function(a,c){if(!c.__type__||!d.pool[a])c.__type__=a,d.pool[a]=
{}};var m=Backbone.Model.extend({defaults:{settings:{}}}),e={getRelativeCreatedAt:function(){var a=this.get("createdAt");if(a)return a=DISQUS.assureOffset(a),moment(a,DISQUS.ISO_8601).fromNow()}},p=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,hasStreaming:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},initialize:function(a,c){var d=
this,c=c||{};d.moderators=c.moderators;d.forum=c.forum;d.users=new f.UserCollection(c.users,{thread:d});d.posts=new f.PostCollection(c.posts,{thread:d,cursor:c.postCursor,order:c.order});d.reactions=new f.ReactionsCollection(null,{thread:d});d.votes=new f.ThreadVoteCollection;d.posts.on("add reset",function(a){a=a.models?a.models:[a];_.each(a,function(a){d.users.get(a.author.id)||d.users.add(a.author)});d.set("posts",Math.max(d.posts.length,d.get("posts")))});d.posts.on("destroy",function(){d.set("posts",
d.get("posts")-1)});d.queue=new f.QueuedPostCollection(null,{thread:d})},_vote:function(a,c){var d=a-c;if(d===0)return d;this.set("likes",this.get("likes")+d);return d},vote:function(a){var c=this;c._vote(a,c.get("userScore"))!==0&&(this.set("userScore",a),DISQUS.api.call("threads/vote.json",{data:{thread:this.id,vote:a},method:"POST",success:function(d){d.response.id&&(c.votes.get(d.response.id)||c.votes.add({id:d.response.id,score:a}))}}))},fetch:function(a){var c=this,d=c.attributes,a=a||{};DISQUS.api.call("threads/details.json",
{data:{thread:d.identifier?"ident:"+d.identifier:"link:"+d.url,forum:d.forum},success:function(d){c.set(d.response);a.success&&a.success()},error:function(){DISQUS.debug?c.save({},{success:a.success}):console.log("Couldn't find thread; not creating in production.")}})},_toggleState:function(a,c){c||(c={});var d=a?"open.json":"close.json";this.set("isClosed",!a);DISQUS.api.call("threads/"+d,{method:"POST",data:{thread:this.id},success:c.success,error:c.error})},open:function(a){this._toggleState(!0,
a)},close:function(a){this._toggleState(!1,a)},sync:function(){var a=this,c=a.attributes;DISQUS.api.call("threads/create.json",{data:{title:c.title,forum:c.forum,identifier:c.identifier,url:c.url},method:"POST",success:function(c){a.set(c.response)}})},incrementPostCount:function(a){this.set("posts",this.get("posts")+a)},isModerator:function(a){if(this.moderators)return a=a instanceof j||_.isObject(a)?a.id:a,a=parseInt(a,10),_(this.moderators).contains(a)},subscribe:function(a,c){var a=a!==!1,d=this.get("userSubscription");
if(d!=a){a?this.set("userSubscription",c||!0):this.set("userSubscription",!1);var e={thread:this.id};if(c)e.email=c;else if(!a&&typeof d==="string")e.email=d;DISQUS.api.call("threads/"+(a?"subscribe.json":"unsubscribe.json"),{data:e,method:"POST"})}},relatedIds:function(){var a=this.get("forum");_.isObject(a);return{forum:this.get("forum"),thread:this.id}},twitterText:function(a){var a=140-(a.length+1),c=DISQUS.next.utils.htmlDecode(this.get("title"));return c=DISQUS.next.utils.niceTruncate(c,a)},
url:function(){var a=this.get("url")||this.get("link");if(!a&&this.currentUrl)a=this.currentUrl;return a}}),a=p.extend({defaults:_.extend({postsInInterval:0,topPost:null},p.prototype.defaults)}),i=Backbone.Model.extend({defaults:function(){return{createdAt:moment().format(DISQUS.ISO_8601),dislikes:0,isApproved:!0,isDeleted:!1,isEdited:!1,isFlagged:!1,isHighlighted:!1,isRealtime:!1,isImmediateReply:!1,isMinimized:null,hasMedia:!1,message:null,raw_message:null,likes:0,media:[],parent:null,points:0,
depth:0,userScore:0}},initialize:function(){this.votes=new f.VoteCollection;this.usersTyping=new f.TypingUserCollection},set:function(a,c,e){if(a&&typeof a!=="string"&&a.author)this.author=new d(j,a.author),delete a.author;return Backbone.Model.prototype.set.call(this,a,c,e)},messageText:function(){var a=this.get("message");return _.strip(a)},relatedIds:function(){var a=this.get("forum");if(_.isObject(a))a=a.id;var c=this.get("thread");if(_.isObject(c))c=c.id;return{forum:a,thread:c,post:this.id}},
twitterText:function(a){var c=140,d;d=this.author.get("name")||this.author.get("username");c-=d.length+3;c-=a.length+1;c-=2;a=this.messageText();a=DISQUS.next.utils.niceTruncate(a,c);return'"'+a+'" \u2014 '+d},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);a.isMinimized=this.get("isMinimized")===!1?!1:!this.get("isApproved");if(this.author)a.author=this.author.toJSON();a.relativeCreatedAt=this.getRelativeCreatedAt();a.formattedCreatedAt=this.getFormattedCreatedAt();a.cid=this.cid;
return a},getFormattedCreatedAt:function(){var a=this.get("createdAt");if(!a)return null;a=DISQUS.assureOffset(a);return moment.utc(a,DISQUS.ISO_8601).local().format("LLLL")},validate:function(a){if(!this.id&&!a.id){if(_.isString(a.raw_message)){if(a.raw_message==="")return c("Comments can't be blank.");if(a.raw_message.length<2)return c("Comments must have at least 2 characters.")}if(a.author_email===""&&a.author_name==="")return c("Please sign in or enter a name and email address.");else if(a.author_email===
""||a.author_name==="")return c("Please enter both a name and email address.");if(_.isString(a.author_email)&&!g.validateEmail(a.author_email))return c("Invalid email address format.")}},report:function(){this.set("isFlagged",!0);DISQUS.api.call("posts/report.json",{data:{post:this.id},method:"POST"})},_vote:function(a,c){var d=a-c,e={likes:this.get("likes"),dislikes:this.get("dislikes"),points:this.get("points")};if(d===0)return d;a>0?(e.likes+=a,e.dislikes+=c):a<0?(e.dislikes-=a,e.likes-=c):c>0?
e.likes-=c:e.dislikes+=c;e.points+=d;this.set(e);return d},vote:function(a){var c=this;c._vote(a,c.get("userScore"))!==0&&(c.set("userScore",a),DISQUS.api.call("posts/vote.json",{data:{post:c.id,vote:a},method:"POST",success:function(a){c.votes.add({id:a.response.id})}}))},_delete:function(){this.set({isApproved:!1,isDeleted:!0});DISQUS.api.call("posts/remove.json",{data:{post:this.id},method:"POST"})},spam:function(){this.set({isApproved:!1,isDeleted:!0,isSpam:!0});this.trigger("spam");DISQUS.api.call("posts/spam.json",
{data:{post:this.id},method:"POST"})},_create:function(a,c){var d=this,e=a.attributes,f={thread:e.thread,message:e.raw_message};if(e.recaptcha_challenge_field)f.recaptcha_challenge_field=e.recaptcha_challenge_field,f.recaptcha_response_field=e.recaptcha_response_field;if(e.parent)f.parent=e.parent;if(e.author_name)f.author_name=e.author_name,f.author_email=e.author_email;DISQUS.api.call("posts/create.json",{data:f,method:"POST",success:function(a){d.set(a.response);c.success&&c.success()},error:c.error})},
_update:function(a,c){var d=this,e=a.attributes;DISQUS.api.call("posts/update.json",{data:{post:e.id,message:e.raw_message},method:"POST",success:function(a){d.set(a.response);c.success&&c.success()},error:c.error})},_read:function(a,c){var d=this,c=c||{};DISQUS.api.call("posts/details.json",{data:{post:d.id},method:"GET",success:function(a){d.set(a.response);c.success&&c.success()},error:c.error})},sync:function(a,c,d){var d=d||{},e=d.error;if(e)d.error=function(a){e(JSON.parse(a.responseText||"{}"))};
switch(a){case "create":this._create(c,d);break;case "update":this._update(c,d);break;case "delete":this._delete();break;case "read":this._read(c,d)}}});_.extend(i.prototype,e);d.addType("Post",i);var l=Backbone.Model.extend({defaults:{userId:null,message:null,parentId:null,immedReply:!1},initialize:function(){this.set("createdAt",moment().format(DISQUS.ISO_8601))},getVisibleParent:function(a){for(var c=this,d;c.get("parentId");){if(d=a.posts.get(c.get("parentId")))return d;c=a.queue.get(c.get("parentId"));
if(!c)break}return null},toPost:function(a){var c=a.posts.get(this.get("parentId")),c=c?c.get("depth")+1:0,c=new d(i,{id:this.id,thread:a.id,message:this.get("message"),parent:this.get("parentId"),depth:c,createdAt:this.get("createdAt"),isRealtime:!0,isImmediateReply:this.get("immedReply")});c.author=a.users.get(this.get("userId"));return c}}),k=Backbone.Model.extend({defaults:{typing:!0},initialize:function(){this.createdAt=moment()}}),r=Backbone.Model.extend({defaults:{about:null,avatar:{cache:DISQUS.urls.media+
"/images/noavatar92.png",permalink:DISQUS.urls.media+"/images/noavatar92.png"},connections:{},email:null,emailHash:null,isAnonymous:!0,isFollowedBy:!1,isFollowing:!1,joinedAt:null,name:null,profileUrl:null,url:null,username:null,numPosts:null,numFollowing:null,numFollowers:null,numLikesReceived:null},hasValidAvatar:function(a){if(!a)a=this.attributes;return(a=a.avatar)&&a.cache},validate:function(a){if(!this.hasValidAvatar(a))return"None of the avatar related properties can be null, undefined or empty on User models."},
toJSON:function(){var a=Backbone.Model.prototype.toJSON.apply(this,arguments);a.thread={};if(!this.hasValidAvatar())a.avatar=this.defaults.avatar;return a}}),o=r.extend({idAttribute:"emailHash"});d.addType("AnonUser",o);var j=r.extend({fetch:function(a){var c=this,a=a||{},d={};if(c.id)d.user=c.id;else if(c.get("username"))d.user="username:"+c.get("username");return DISQUS.api.call("users/details.json",{data:d,success:function(d){d=d.response;c.set(d);a.success&&a.success(d);a.complete&&a.complete(d)},
error:function(c){a.error&&a.error(c);a.complete&&a.complete(c)}})},toJSON:function(){var a=r.prototype.toJSON.call(this),c=this.collection&&this.collection.thread;a.thread.canModerate=!!c&&c.isModerator(this);return a},_changeFollowState:function(a){this.set("isFollowing",a);DISQUS.api.call("users/"+(a?"follow":"unfollow")+".json",{data:{target:this.id},method:"POST"})},follow:function(){this._changeFollowState(!0)},unfollow:function(){this._changeFollowState(!1)},toggleFollowState:function(){this._changeFollowState(!this.get("isFollowing"))}});
d.addType("User",j);var n=j.extend({defaults:_.extend({numPosts:0},j.prototype.defaults)}),t=Backbone.Model.extend({initialize:function(){this.user=new d(o)},_eventProxy:function(){this.trigger.apply(this,arguments)},_setProxy:function(){this.user.on("all",this._eventProxy,this)},_clearProxy:function(){this.user&&this.user.off("all",this._eventProxy,this)},_setUser:function(a){this._clearProxy();this.user=a;this._setProxy();this.notifications=new f.NotificationCollection(null,{user:this.user});this.notifications.on("markRead",
function(a){this.set("notificationCount",this.get("notificationCount")-a.length)},this);this.trigger("change:id",a)},isRegistered:function(){return this.user instanceof j},isAnonymous:function(){return this.user instanceof o},fetch:function(a){var a=a||{},c={};c["_"+(new Date).getTime()]=1;return DISQUS.api.call("users/details.json",{data:c,success:_.bind(function(c){c=c.response;c.id&&this._setUser(new d(j,c));a.success&&a.success(c);a.complete&&a.complete(c)},this),error:_.bind(function(c){a.error&&
a.error(c);a.complete&&a.complete(c)},this)})}}),u=function(){var a=t.extend({defaults:{canReply:!0,canModerate:!1,discoveryVariant:null,mustVerifyEmail:!1,isReadOnly:!1,audienceSyncVerified:!1,notificationCount:null},toJSON:function(){var a=this.user.toJSON.apply(this.user,arguments);a.thread.canReply=this.get("canReply");if(!a.thread.canModerate)a.thread.canModerate=this.get("canModerate");return a},needsAudienceSyncAuth:function(a){return a.get("settings").audienceSyncEnabled&&this.isRegistered()&&
!this.get("audienceSyncVerified")},fetch:function(a){var c=this;if(c._request)c._request.abort(),c._request=null;var a=a||{thread:{}},e={thread:a.thread.id,post:a.thread.posts.pluck("id")};if(a.discovery)e.discovery=a.discovery;e["_"+(new Date).getTime()]=1;c._request=DISQUS.api.call("embed/threadDetails.json",{data:e,success:function(e){var e=e.response,f={};e.user&&_.extend(f,e.user,{votes:e.votes});c.set(e.session);c.set("discoveryVariant",e.discovery);f.id&&(c._setUser(new d(j,f)),a.thread.users.add(c.user),
e.thread&&(a.thread.set("userScore",e.thread.userScore),a.thread.set("userSubscription",e.thread.userSubscription)));a.success&&a.success(e);c.trigger("identify",c)},error:function(c){a.error&&a.error(c)},complete:function(d){c._request=null;a.complete&&a.complete(d)}});return c._request},register:function(a,c){var e=this;DISQUS.api.call("internal/users/register.json",{secure:!0,data:{display_name:a.name,email:a.email,password:a.password},method:"POST",success:function(a){e._setUser(new d(j,a.response));
c.success&&c.success.call(e,a.response)},error:c.error||function(){}})},logout:function(){var a=this;DISQUS.api.call("internal/users/logout.json",{method:"POST",success:function(){a._setUser(new d(o))}})}}),c;return{get:function(){return c=c||new a},setDefaults:function(d){if(c)throw Error("Session defaults cannot be changed after a session instance is created!");a.defaults=_.extend(a.prototype.defaults,d);return a.defaults},forget:function(){c=null}}}(),z=Backbone.Model.extend({defaults:{score:0}}),
A=Backbone.Model.extend({defaults:{score:0}}),w=Backbone.Model.extend({defaults:function(){return{object:{},type:"",createdAt:moment().format(DISQUS.ISO_8601)}},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this),c=DISQUS.assureOffset(this.get("createdAt"));a.relativeCreatedAt=moment(c,DISQUS.ISO_8601).fromNow();return a}}),v=Backbone.Model.extend({defaults:function(){return{sender:"",timestamp:moment().valueOf(),type:0,formatted:"",theme:"",createdAt:null,post:null}},set:function(a,
c){if(a&&typeof a!=="string"&&a.post)this.post=new i(a.post),delete a.post;return Backbone.Model.prototype.set.call(this,a,c)},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(this.post)a.post=this.post.toJSON();a.relativeCreatedAt=this.getRelativeCreatedAt();return a}});_.extend(v.prototype,e);var e=Backbone.Model.extend({defaults:{enabled:!1}}),G=Backbone.Model.extend({defaults:{thread:null,forum:null,body:null,service:{url:null,name:null},url:null,title:null},set:function(a,
c){if(a&&typeof a!=="string"){if(a.author)this.author=new d(a.author.id?j:o,a.author),delete a.author;if(a.createdAt)a.relativeCreatedAt=moment(DISQUS.assureOffset(a.createdAt),DISQUS.ISO_8601).fromNow()}return Backbone.Model.prototype.set.call(this,a,c)},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);if(this.author)a.author=this.author.toJSON();return a},destroy:function(){DISQUS.api.call("reactions/remove.json",{data:{reaction:this.id,forum:this.get("forum")},method:"POST"})}});
return{UniqueModel:d,Forum:m,Thread:p,TopThread:a,Post:i,QueuedPost:l,Reaction:G,TypingUser:k,User:j,AnonUser:o,Session:u,BaseSession:t,TopUser:n,Vote:z,ThreadVote:A,Notification:v,ActivityItem:w,Switch:e}});
DISQUS.define("next.collections",function(){var d=DISQUS.use("next.models"),f=DISQUS.use("next.utils"),g=Backbone.Collection.extend({model:d.ThreadVote}),c=Backbone.Collection.extend({model:_.bind(d.UniqueModel,{},d.User),initialize:function(a,c){Backbone.Collection.prototype.initialize.apply(this,arguments);this.thread=c&&c.thread}}),m=Backbone.Collection.extend({model:d.Vote}),e=Backbone.Collection.extend({PER_PAGE:10,initialize:function(a,c){c=c||{};this.cursor=c.cursor||{}},fetch:function(a){a=
a||{};a.data=_.defaults(a.data||{},{cursor:a.cursor||"",limit:this.PER_PAGE});return Backbone.Collection.prototype.fetch.call(this,a)},more:function(a){function c(a){e.push(a)}var d=this,a=a||{};if(this.cursor.hasNext){var e=[];this.on("add",c);this.fetch(_.extend({},a,{add:!0,remove:!1,cursor:this.cursor.next,success:function(){d.trigger("add:many",e,d,a);d.off("add",c);a.success&&a.success()}}))}else a.error&&a.error()},parse:function(a){this.cursor=a.cursor;return Backbone.Collection.prototype.parse.call(this,
a)}}),p=e.extend({model:d.Notification,url:DISQUS.api.getURL("messagesx/list"),initialize:function(a,c){this.user=c.user;e.prototype.initialize.apply(this,arguments)},markRead:function(){var a=this.getUnread();if(a.length){var c=_.pluck(a,"id");DISQUS.api.call("messagesx/markRead.json",{data:{messages:c},method:"POST"});_.invoke(a,"set","isRead",!0);this.trigger("markRead",c)}},getUnread:function(){return this.filter(function(a){return!a.get("isRead")})}}),a=e.extend({PER_PAGE:50,model:_.bind(d.UniqueModel,
{},d.Post),url:DISQUS.api.getURL("threads/listPostsThreaded"),initialize:function(a,c){e.prototype.initialize.apply(this,arguments);this.thread=c.thread;this.order=c.order},fetch:function(a){a=a||{};this.order==="popular"?f.cookies.erase("disqus.order"):f.cookies.create("disqus.order",this.order);a=_.extend(a,{data:{limit:this.PER_PAGE,thread:this.thread.id,forum:this.thread.get("forum"),order:this.order}});return e.prototype.fetch.call(this,a)}}),i=Backbone.Collection.extend({model:d.QueuedPost,
initialize:function(a,c){var d=this;d.thread=c.thread;d.counters={comments:0,replies:{}};d.on("add",function(a){var c=a.getVisibleParent(d.thread),e=d.counters.replies;c?(e[c.id]=(e[c.id]||0)+1,c.id==a.get("parentId")&&a.set("immedReply",!0)):d.counters.comments+=1})},comparator:function(a){return parseInt(a.id,10)},isDescendant:function(a,c){var b;var d=a.get("parentId"),d=d?this.get(d):null,e={};for(_.each(c,function(a){e[a]=!0});d;){if(e[d.get("id")]===!0)return!0;b=(d=d.get("parentId"))?this.get(d):
null,d=b}return!1},drain:function(a){function c(a){var d=[];e.each(function(a){a.get("parentId")===null&&d.push(a.get("id"))});e.reset(e.filter(function(c){if(c.get("parentId")!==null&&!e.isDescendant(c,d))return c;a(c)}));e.counters.comments=0}function d(c){var f=[],g;g=e.filter(function(c){var d=c.getVisibleParent(e.thread);if(!d||d.get("id")!=a)return c;f.push(c)});f=_.sortBy(f,function(a){return parseInt(a.get("id"),10)});_.each(f,function(a){c(a)});e.reset(g);e.counters.replies[a]=0}var e=this;
return(a?d:c)(function(a){e.thread.posts.add(a.toPost(e.thread))})}}),l=Backbone.Collection.extend({model:d.Switch,parse:function(a){return _.map(a,function(a,c){return{id:c,enabled:a}})},enabled:function(a){return(a=this.get(a))?a.get("enabled"):!1}}),k=Backbone.Collection.extend({models:d.TypingUser,initialize:function(){var a=this;a.gc=null;a.on("add remove reset",function(){var c=a.count();if(c>0&&a.gc===null)a.gc=setInterval(_.bind(a.cleanup,a),6E4);else if(c<=0&&a.gc!==null)clearInterval(a.gc),
a.gc=null},a)},count:function(){var a=0;this.each(function(c){a+=c.get("typing")?1:-1});return a},cleanup:function(){var a=moment();this.reset(this.filter(function(c){return c.createdAt.diff(a,"minutes")>5}))}}),r=Backbone.Collection.extend({model:d.ActivityItem,url:DISQUS.api.getURL("users/listActivity"),initialize:function(a,c){this.user=c.user;this.include=c.include||null},fetch:function(a){var a=a||{},c={user:"username:"+this.user.get("username")};if(this.include)c.include=this.include;a.data=
_.defaults(a.data||{},c);Backbone.Collection.prototype.fetch.call(this,a)}}),o=e.extend({model:_.bind(d.UniqueModel,{},d.Post),url:DISQUS.api.getURL("users/listPostActivity")}),j=Backbone.Collection.extend({model:d.TopThread,url:DISQUS.api.getURL("threads/listPopular"),initialize:function(a,c){this.forum=c.forum;this.limit=c.limit},set:function(a,c){c.parse&&(a=this.parse(a,c),delete c.parse);_.isArray(a)||(a=a?[a]:[]);a=_.reject(a,function(a){return a.title.match(/^http/i)});Backbone.Collection.prototype.set.call(this,
a,c)},fetch:function(a){Backbone.Collection.prototype.fetch.call(this,_.extend({data:{forum:this.forum,limit:this.limit,interval:"7d",with_top_post:!0}},a))}}),n=Backbone.Collection.extend({model:d.TopUser,url:DISQUS.api.getURL("forums/listMostActiveUsers"),initialize:function(a,c){this.forum=c.forum;this.limit=c.limit;this.discardLowRep=c.discardLowRep},fetch:function(a){Backbone.Collection.prototype.fetch.call(this,_.extend({data:{forum:this.forum,limit:this.limit}},a))},parse:function(a){if(!this.discardLowRep)return a.response;
return _.filter(a.response,function(a){if(parseFloat(a.rep)>0.7)return a})}}),d=e.extend({PER_PAGE:20,model:d.Reaction,url:DISQUS.api.getURL("threads/listReactions"),initialize:function(a,c){this.thread=c.thread},fetch:function(a){a=a||{};a=_.extend(a,{data:{limit:this.PER_PAGE,thread:this.thread.id}});return e.prototype.fetch.call(this,a)}});return{PaginatedCollection:e,UserCollection:c,PostCollection:a,ReactionsCollection:d,TypingUserCollection:k,TopUserCollection:n,TopThreadCollection:j,VoteCollection:m,
ThreadVoteCollection:g,ActivityCollection:r,PostActivityCollection:o,NotificationCollection:p,QueuedPostCollection:i,SwitchCollection:l}});
DISQUS.define("next.views",function(){function d(b){return(b=b&&b.match(/discovery\-([\w\-]+)/))&&b[1]}function f(b){return function(a){a&&a.preventDefault&&a.preventDefault();b.apply(this,arguments)}}function g(b,a){var c="[data-action^="+a+"]",d=$(b),d=d.is(c)&&d||d.closest(c);return(d.attr("data-action")||":").split(":")[1]}var c=DISQUS.use("next.models"),m=DISQUS.use("next.collections"),e=DISQUS.use("next.utils"),p=DISQUS.use("next.realtime"),a=DISQUS.use("Bus"),i=DISQUS.use("JSON"),l=DISQUS.strings.get,
k,r={_getShortUrl:function(b){var a=this,c=this._shareUrl(),d=c,c=_.extend({url:c,source:"disqus_embed_next"},this.model.relatedIds());DISQUS.api.call("shortener/create.json",{method:"POST",data:c,timeout:5E3,success:function(b){if(b.code===0)d=b.response.url},complete:function(){b.call(a,d)}})},_shareWaitPopup:function(b){return window.open(DISQUS.urls.loading,"_blank",b||"width=550,height=520")},share:function(b){this.sharers[b].call(this)},sharers:{twitter:function(){var b=this._shareWaitPopup();
this._getShortUrl(function(a){b.location=DISQUS.serialize("https://twitter.com/intent/tweet",{url:a,text:this.model.twitterText(a)})})},facebook:function(){var b=this._shareWaitPopup("width=655,height=352");this._getShortUrl(function(a){b.location=DISQUS.serialize("https://www.facebook.com/sharer.php",{u:a})})}}},o={alert:function(b,a){a?_.isString(a)&&(a={type:a}):a={};this._alert&&this._alert.dismiss();var c=this._alert=new P(_.extend({message:b},a));this.updateDom(function(){c.render().$el.prependTo($("#form")[0])});
return c}},j=Backbone.View.extend({events:{"click [data-action^=auth:]":"handleAuth","click [data-action=verify-email]":"verifyEmail","click [data-action=audiencesync]":"audienceSync","click [data-action=profile]":"handleShowProfile","click [data-action=sort]":"handleSort","click [data-action=close-thread]":"closeThread","click [data-action=open-thread]":"openThread","click [data-action=debug]":"renderDebugInfo"},STREAMING_MAX_VISIBLE:250,MEDIA_PERSISTED_WIDTHS:[320,480,600,800],MAX_MEDIA_HEIGHT:480,
initialize:function(b){k=this;b=b||{};b=b.jsonData||{};this.initialData=b.response||{};this.profileWindowName=_.uniqueId("disqus_");if(e.extract(b,"response.forum.id"))DISQUS.urls.moderate=e.updateURL(DISQUS.urls.moderate,{hostname:b.response.forum.id+"."});this.theme=e.extract(this.initialData,"theme.base")||{};c.Session.setDefaults(this.initialData.session);this.session=c.Session.get();this.bindSessionEvents();this.forum=new c.Forum;this.initialData&&this.initialData.forum&&this.forum.set(this.initialData.forum);
this.thread=new c.Thread(null,{forum:this.forum,postCursor:b.cursor,moderators:(this.initialData.thread||{}).moderators,order:b.order});this.posts=this.thread.posts;this.postsToAppend=[];this.postsToPrepend=[];this.switches=new m.SwitchCollection;this.states={templateReady:!1,realtimeIndicatorsCreated:!1,ravenConfigured:!1,inViewport:!1,streamingPaused:!1};this.forum.get("settings").backplaneEnabled&&this.enableBackplane();a.on("window.inViewport",function(){this.states.inViewport=!0;this.trigger("inViewport")},
this);a.on("window.scrollOffViewport",function(){this.states.inViewport=!1},this);a.on("switches.changed",function(b){this.switches.reset(this.switches.parse(b));if(!this.states.ravenConfigured&&this.switches.enabled("next_raven"))Raven.config({servers:["http://disqus.com/raven/api/store/"],logger:"javascript.next",ignoreErrors:["Script error."]}),window.onerror=Raven.process,DISQUS.api.defaults({error:function(b){Raven.captureMessage({name:"API call failed.",message:b})}}),this.states.ravenConfigured=
!0;this.switches.enabled("next_comments_truncation_enabled")&&_.invoke(this.postViews,"manageMessageHeight");if(!this.switches.enabled("next_lazy_embed")||this.states.inViewport)this.fetchSession();else this.on("inViewport",this.fetchSession,this);this.initLinkAffiliator()},this);a.on("init",function(b){k.bootstrap(b)});b={};if(typeof this.initialData==="object"&&!_.isEmpty(this.initialData))b.thread={id:this.initialData.thread.id};a.sendHostMessage("ready",b)},_templateReady:function(){window.Handlebars.lounge.templates();
this.updateModeratorText();this.states.templateReady=!0;this.renderLayout();_.defer(_.bind(this.trigger,this,"templateReady"))},enableBackplane:function(){this.backplaneCredentialsReady=!1;this.events["click [data-action=logout]"]=function(b){if(this.backplaneCredentialsReady)b.preventDefault(),a.sendHostMessage("backplane.invalidate",{redirectUrl:DISQUS.urls.logout});else return!0};this.session.on("identify",function(){if(this.backplaneCredentialsReady&&!this.session.isRegistered())a.sendHostMessage("backplane.invalidate"),
this.backplaneCredentialsReady=!1,DISQUS.api.headers({Authorization:null})},this);a.on("login",function(b){b.backplane!==null&&(this.setBackplaneHeaders(b.backplane),this.fetchSession())},this);a.sendHostMessage("loadBackplane")},setBackplaneHeaders:function(b){b="Backplane "+i.stringify({provider:"janrain",message_id_url:b.messageUrl,channel_name:b.channel,forum_id:this.forum.id});this.backplaneCredentialsReady=!0;DISQUS.api.headers({Authorization:b})},bootstrap:function(b){var h=this;h.config=b||
{};var c={};this.discoveryOverride=d(b.parentWindowHash);if(b.apiKey)c["X-Disqus-Publisher-API-Key"]=b.apiKey;if(b.remoteAuthS3)c["X-Disqus-Remote-Auth"]=b.remoteAuthS3;_.isEmpty(c)||DISQUS.api.headers(c);b.anchorColor&&function(){var a=e.escapeColor(b.anchorColor);e.addStylesheetRules([[".publisher-anchor-color a",["color",a,!0]],["a.publisher-anchor-color",["color",a,!0]],[".publisher-anchor-hover a:hover",["color",a,!0]],["a.publisher-anchor-hover:hover",["color",a,!0]],[".active .publisher-nav-color:after",
["background",a,!0]],[".media-preview .active.publisher-border-color",["border-color",a,!0]]])}();e.injectBaseElement(b.referrer);if(b.referrer)h.thread.currentUrl=b.referrer;if(b.width)document.body.style.width=b.width+"px";if(b.permalink)h.once("postsRendered",function(){h.once("domReflow",function(){h.scrollToPost(b.permalink,{highlight:!0})})});if(b.sso)DISQUS.templateGlobals.sso=b.sso;this.loadTheme(b);h.on("templateReady",h.findClosestThumbnailSize,h);h.on("templateReady",h.renderForm,h);h.on("templateReady",
h.updatePostCount,h);h.on("templateReady",h.initCommunity,h);h.on("templateReady",h.initReactions,h);h.on("templateReady",h.initUserMenu,h);h.on("templateReady",h.initThreadVotes,h);h.on("templateReady",h.initThreadShareMenu,h);h.on("templateReady",h.initThreadSubscribe,h);h.on("templateReady",h.renderStreamingToggle,h);h.on("templateReady",h.initRealtime,h);h.renderBindings([h.thread,"change:likes",h.updateThreadVotes],[h.thread,"change:userScore",h.updateThreadUserScore],[h.thread,"change:posts",
h.updatePostCount],[h.thread.posts,"reset",h.redrawPosts],[h.thread.posts,"add",h.addPosts],[h.thread.posts,"remove",h.removePost],[h.thread.posts,"reset add",h.toggleLoadMorePosts],[h.thread.posts,"reset add",h.toggleNoPosts],[h.thread.reactions,"reset add",h.toggleLoadMoreReactions],[h.session,"change:id",h.updateThreadSessionData],[h.session,"change:id",h.initDashboard]);h.on("scroll",function(b){h.position=b;if(h.currentSection==="conversation")h.conversationPosition=b});h.on("scrollOffViewport",
function(){h.states.realtimeIndicatorsCreated&&h.currentSection==="conversation"&&(a.sendHostMessage("realtime.hideNorth"),a.sendHostMessage("realtime.hideSouth"))});h.on("scroll",h.processDeferredImages,h);h.on("domReflow",function(){h.deferredImages=null;a.sendHostMessage("fakeScroll")});a.on("window.resize",_.bind(a.sendHostMessage,a,"fakeScroll"));h.on("scroll",h.handleRealtimeScroll,h);a.on("window.hashchange",function(b){h.discoveryOverride=d(b);if(h.discoveryOverride)return h.fetchSession();
(b=b&&b.match(/comment\-([0-9]+)/))&&h.scrollToPost(b[1],{highlight:!0})});a.on("window.scroll",function(b){h.trigger("scroll",b)});a.on("window.scrollOffViewport",function(){h.trigger("scrollOffViewport")});a.on("window.resize",h.resize,h);a.on("realtime.click",h.handleRealtimeClick,h);h.thread.queue.on("add reset",h.toggleRealtimeNotifications,h);h.on("postsRendered",h.toggleRealtimeNotifications,h);h.thread.set(this.initialData.thread);h.posts.reset(this.initialData.posts);var B=$("body");h.getTypeface()===
"serif"&&B.addClass("serif");h.getColorScheme()==="dark"&&B.addClass("dark");h.bindBusListeners();_.delay(function ha(){h.postViews&&!(_.size(h.postViews)<1)&&(_.invoke(h.postViews,"updateRelativeTime"),_.delay(ha,6E4))},6E4);h.currentSection="conversation";h.thread.on("create",function(b){a.sendHostMessage("posts.create",b.toJSON())});var c=$(window),f=B.width(),g=_.debounce(function(){var b=B.width();f!=b&&h.postViews&&(f=b,_.each(h.postViews,function(b){b.manageMessageHeight()}))},50);c.on("resize",
g);h.initialized=!0},bindBusListeners:_.once(function(){var b=this;a.on("!auth:success",function(a){a&&(a.sessionId&&DISQUS.api.headers({"X-Sessionid":a.sessionId}),a.message&&b.alert(a.message,{type:"info"}),a.logEvent&&k.trigger("uiAction:"+a.logEvent));this.fetchSession()},this);a.on("!audiencesync:grant",function(){this.session.set("audienceSyncVerified",!0)},this)}),initLinkAffiliator:function(){if(this.switches.enabled("enable_link_affiliation")&&e.extract(this,"initialData.forum.settings.linkAffiliationEnabled")&&
!this.isHttps()&&!this.initLinkAffiliatorCalled){this.initLinkAffiliatorCalled=!0;var b=e.extract(this,"initialData.forum.pk");if(_.isNumber(b)){var h=new Q({el:document.body});a.on("affiliationOptions",function B(b){a.off("affiliationOptions",B);b&&_.isNumber(b.timeout)&&h.trigger("options.timeout",b.timeout)});a.sendHostMessage("loadLinkAffiliator",{clientUrl:DISQUS.urls.linkAffiliatorClient,apiUrl:"//links.services.disqus.com/api",key:"cfdfcf52dffd0a702a61bad27507376d",id:b})}}},loadTheme:function(b){var a=
this.theme.js,c=this.theme.css,d=function(b,a){return DISQUS.serialize((a||"js")+"!"+b,null,DISQUS.debug)};this.language=b=b.language||this.initialData.forum.language||"en";var a=curl([d(c,"css"),d(a)]),e=_.bind(this._templateReady,this);b!=="en"&&(a=a.next([d(DISQUS.urls.translations+"/"+b+".js")]));a.then(e,function(b){e();DISQUS.log(b)})},bindSessionEvents:_.once(function(){this.session.on("change:isReadOnly",function(){this.session.get("isReadOnly")&&this.alert(l("The Disqus comment system is temporarily in maintenance mode. You can still read comments during this time, however posting comments and other actions are temporarily delayed."))},
this);this.session.on("identify change:audienceSyncVerified",function(){this.session.get("audienceSyncVerified")&&a.sendHostMessage("session.identify",this.session.user.id)},this);this.session.on("change:discoveryVariant",this.initDiscovery,this);this.session.on("identify change:mobileNag",function(){if(this.states.templateReady)this.showMobileNag();else this.once("templateReady",this.showMobileNag,this)},this)}),showMobileNag:function(){DISQUS.browser.mobile&&this.session.get("mobileNag")&&this.alert('<a href="'+
DISQUS.urls.root+"/mobile-demo?thread="+this.thread.id+'" target="_blank" class="mobile-button"><span class="logo"></span><span class="link">Launch Disqus Mobile</span></a>',{safe:!0,type:"button"})},fetchSession:function(){var b={thread:this.thread};if(this.switches.enabled("discovery_next:override")&&this.discoveryOverride)b.discovery=this.discoveryOverride;return this.session.fetch(b)},initRealtimeIndicators:function(){if(!this.switches.enabled("disable_realtime_indicators")&&!this.states.realtimeIndicatorsCreated){var b=
$("html").width()+"px",b={width:b,minWidth:b,maxWidth:b,position:"fixed"},h={contents:DISQUS.renderBlock("realtimeIndicator",{orientation:"north"}),styles:{top:"0"}},c={contents:DISQUS.renderBlock("realtimeIndicator",{orientation:"south"}),styles:{bottom:"0"}};_.defaults(h.styles,b);_.defaults(c.styles,b);a.sendHostMessage("realtime.init",{north:h,south:c});this.states.realtimeIndicatorsCreated=!0}},insertStreamingComments:_.throttle(function(){var b=this.thread.queue;b.drain();_.each(b.counters.replies,
function(a,c){b.drain(c)})},1E3),getTypeface:function(){var b=this.forum.get("settings");return b.typeface==="auto"?this.config.typeface:b.typeface},getColorScheme:function(){var b=this.forum.get("settings");return b.colorScheme==="auto"?this.config.colorScheme:b.colorScheme},updateModeratorText:function(){var b=this.forum.get("settings");if(b.moderatorText)DISQUS.strings.translations.Mod=b.moderatorText},handleRealtimeScroll:function(b){if(this.states.inViewport&&this.states.realtimeIndicatorsCreated&&
this.currentSection==="conversation"){var h=_.union([this.queueView],_.values(this.postViews)),c=0,d=0;_.each(h,function(a){if(a&&!a.getDirection)a=a.queueView;if(a&&!(a.options.count<=0)){var h=a.getDirection(b);h===1?c+=a.options.count:h===-1&&(d+=a.options.count)}});var h="realtime.hideNorth",e;c>0&&(h="realtime.showNorth",e=DISQUS.renderBlock("realtimeIndicatorText",{num:c,orientation:"north"}));a.sendHostMessage(h,e);h="realtime.hideSouth";e=void 0;d>0&&(e=DISQUS.renderBlock("realtimeIndicatorText",
{num:d,orientation:"south"}),h="realtime.showSouth");a.sendHostMessage(h,e)}},handleRealtimeClick:function(b){var h=this;a.sendHostMessage("realtime.hide"+(b==="north"?"North":"South"));var c=_.union([h],_.toArray(h.postViews)),d,e,c=_.filter(c,function(a){a=a.queueView;if(!a||a.options.count<=0)return!1;var c=b==="north"?1:-1;if(a.getDirection(h.position)!==c)return!1;return!0}),c=_.sortBy(c,function(b){if(b===h)return 0;return b.offset.top}),c=b==="north"?_.last(c):_.first(c);d=c.queueView;e=c===
h?0:c.offset.top-100;d.drainHandler();var f=function(){a.sendHostMessage("scrollTo",{top:e});j.getInstance().off("domReflow",f)};j.getInstance().on("domReflow",f)},toggleRealtimeNotifications:function(){var b=this,h=b.thread.queue;b.updateDom(function(){_.defer(function(){a.sendHostMessage("fakeScroll")});if(!h.length)return void $("[data-role=realtime-notification]").hide();if(b.thread.get("hasStreaming"))return void b.insertStreamingComments();if(h.counters.comments){var c=b.queueView||new E({model:b.thread,
el:b.$el.find("button[data-role=realtime-notification]")});b.queueView=c;c.setCount(h.counters.comments);c.render()}_.each(h.counters.replies,function(a,h){var c=b.thread.posts.get(h);if(c){var d=b.postViews[c.cid];if(d){var e=d.queueView;if(!e)e=new R({thread:b.thread,postView:d,model:c,el:d.$el.find("[data-role=realtime-notification:"+h+"] a")}),d.queueView=e;e.setCount(a);e.render()}}})})},renderDebugInfo:f(function(){if(this.session.user.get("isGlobalAdmin")){for(var b=[],a=0,c=this.switches.models.length;a<
c;a++)this.switches.models[a].attributes.enabled&&b.push(this.switches.models[a].id);var d=new S({Shortname:this.thread.get("forum"),"Thread ID":this.thread.get("id"),"Thread slug":this.thread.get("slug"),"Anchor color":e.escapeColor(this.config.anchorColor),Switches:b.join(", ")});d.render();this.updateDom(function(){var b=document.body;b.insertBefore(d.el,b.firstChild)})}}),scrollToPost:function(b,h){var h=h||{},d=this;if(d.currentSection!=="conversation")h.force=!0;d.mainNav.navTo("conversation");
var e=d.$el.find("#post-"+b);if(e.length)h.highlight&&(d.$el.find(".post-content.target").removeClass("target"),e.find(".post-content").first().addClass("target")),_.delay(function(){a.sendHostMessage("scrollTo",{top:e.offset().top+(h.padding||0),force:h.force||null})},100);else if(d.hasQueuedPosts())d.once("postsRendered",_.bind(d.scrollToPost,d,b,h));else DISQUS.api.call("posts/getContext.json",{method:"GET",data:{post:b},success:function(a){a=_.filter(a.response,function(b){return b.thread==d.thread.get("id")});
a.length!==0&&(_.each(a,function(b){b=new c.UniqueModel(c.Post,b);b.requestedByPermalink=!0;d.thread.posts.add(b)}),d.once("postsRendered",_.bind(d.scrollToPost,d,b,h)))}})},updateThreadSessionData:function(b){b&&(b.get("thread")&&this.thread.set(b.get("thread")),(b=b.get("votes"))&&typeof b==="object"&&_.each(b,function(b,a){var c=this.posts.get(a);c&&c.set("userScore",b)},this))},initDashboard:function(){var b=$("#main-nav [data-nav=dashboard]");if(this.session.isAnonymous())return b.hide();b.show();
this.notificationCount=new I({el:b.find("[data-role=notification-count]")[0],session:this.session,max:99});this.notificationCount.render();this.session.on("change:notificationCount",function(){this.session.get("notificationCount")<=0&&this.notificationCount.remove()},this);this.dashboard=new T({el:"#dashboard",session:this.session,notifications:this.notifications});this.dashboard.render()},initCommunity:function(){this.community=new U({el:document.getElementById("community"),forum:this.forum})},initReactions:function(){this.reactions=
new K({el:$("#reaction-list")[0],collection:this.thread.reactions,thread:this.thread,session:this.session});this.forum.get("settings").hasReactions&&$("#global-nav").length===0&&(this.thread.reactions.on("reset",function(){$("#reactions").show()}),this.thread.reactions.fetch({reset:!0}))},_getLogoutUrl:function(){return this.config.sso&&this.session.user.get("user_type")==="sso"?this.config.sso.logout:DISQUS.urls.logout},initUserMenu:function(){var b=this.userMenu=new A({el:this.$el.find("[data-role=logout]")[0],
session:this.session,thread:this.thread,logoutUrl:this._getLogoutUrl(),referrerUrl:this.config.referrer});this.session.on("change:id",function(){b.logoutUrl=this._getLogoutUrl();b.render()},this);this.thread.on("change:isClosed",this.render,this);b.render()},initThreadShareMenu:function(){this.threadShareMenu=new t({el:$("#thread-share-menu")[0],model:this.thread})},initDiscovery:function(b,a){function c(){if(!d.states.templateReady)return void d.on("templateReady",function ja(){d.off("templateReady",
ja);c()});DISQUS.discovery.init(_.extend({},a,{sourceThread:d.initialData.thread,sourceForum:d.initialData.forum,containerId:"discovery",session:b})).on("resize",function(){d.updateDom()})}var d=this;if(!a)return void DISQUS.log("Discovery seems not enabled. Check Gargoyle switches or forum settings.");DISQUS.discovery=null;curl(["css!"+a.css,"js!"+a.js]).then(function(){c();window.Handlebars.discovery&&window.Handlebars.discovery.templates()})},toggleLoadMorePosts:function(){var b=this.$el.find("#posts [data-role=more]");
this.updateDom(function(){this.thread.posts.cursor.hasNext?b.show():b.hide()},this)},toggleLoadMoreReactions:function(){var b=this.$el.find("#reactions [data-role=more]");this.updateDom(function(){this.thread.reactions.cursor.hasNext?b.show():b.hide()},this)},isHttps:function(){return window.location.protocol==="https:"},isRealtimeEnabled:function(){var b=moment.unix(this.initialData.lastModified);return!this.thread.get("isClosed")&&(this.switches.enabled("realtime_for_oldies")||moment().diff(b,"days")<=
7)},realtimeHandlers:{Post:function(b){var b=b.data,a=this.thread;if(!this.thread.get("hasStreaming")||!this.states.streamingPaused){if(!b.id)return void DISQUS.logError("RT: no post ID");if(!b.author||!b.author.id)return void DISQUS.logError("RT: no author or author ID");if(!b.author.name||!b.author.email_md5)return void DISQUS.logError("RT: no author name or email hash");if(!b.post||!b.post.message)return void DISQUS.logError("RT: no post message");if(a.posts.get(b.id)||a.queue.get(b.id))return void DISQUS.log("RT: duplicate: ",
b.id);if(b.type!=="approved")return void DISQUS.log("RT: unnaproved: ",b.id);if(b.type===b.type_prev)return void DISQUS.log("RT: Post change message, ignoring for now",b.id);this.thread.incrementPostCount(1);var d=b.post.parent_post.id;if((d=d!=="0"?d:null)&&!a.posts.get(d)&&!a.queue.get(d))return void DISQUS.log("RT: parent is not on this page: ",b.id);var e=b.author.id,f=a.users.get(e);f||(f=new c.UniqueModel(c.User,{id:e,name:b.author.name,emailHash:b.author.email_md5,isAnonymous:b.author.id===
"0"}),b.author.avatar&&f.set("avatar",{cache:b.author.avatar,permalink:b.author.avatar}),a.users.add(f));a.queue.add({id:b.id,userId:f.get("id"),parentId:d,message:b.post.message})}},Vote:function(b){var a=b.data;if(a.id&&a.vote){var d=this.thread.posts.get(a.vote.recipient_post_id);!(this.session.user.id&&a.vote.voter_id===this.session.user.id)&&d&&(DISQUS.log("RT: Vote for post ",d.id),b=d.votes.get(a.id),b||(DISQUS.log("RT: Creating new vote with id ",a.id),b=new c.Vote({id:a.id}),d.votes.add(b)),
a=d._vote(a.vote.vote,b.get("score")),a!==0&&b.set("score",a))}},ThreadVote:function(b){var a=b.data,d=this.thread;a.id&&a.vote&&!(this.session.user.id&&a.vote.voter_id==this.session.user.id)&&(b=d.votes.get(a.id),b||(b=new c.ThreadVote({id:a.id}),d.votes.add(b)),a=d._vote(a.vote.vote,b.get("score")),a!==0&&b.set("score",a))},IsTyping:function(b){var a=b.data,d=this.thread;a.thread_id==d.id&&a.post.parent_post.id&&(d=d.posts.get(a.post.parent_post.id))&&(d.usersTyping.get(b.lastEventId)||(!(d.usersTyping.count()<=
0)||a.typing)&&d.usersTyping.add(new c.TypingUser({id:b.lastEventId,typing:a.typing})))}},initRealtime:function(){if(!p.Manager.pipe&&this.isRealtimeEnabled()){this.initRealtimeIndicators();var b;if(this.switches.enabled("aggressive_embed_cache"))b=this.initialData.lastModified;p.Manager.initialize(this.thread.id,b,this.realtimeHandlers,this)}},renderBindings:function(){var b=this;_.each(arguments,function(a){var c=a[2];a[0].on(a[1],function(){var a=arguments;if(b.states.templateReady)c.apply(b,a);
else b.on("templateReady",function(){c.apply(b,a)})})})},updateDom:function(){var b=_.debounce(function(){this.resize();this.trigger("domReflow")},0);return function(a,c){a&&a.call(c);b.call(this)}}(),initThreadVotes:_.debounce(function(){var b;this.threadVotes&&this.threadVotes.remove();this.threadVotes=b=new u({thread:this.thread,session:this.session});b.on("vote:up",_.bind(this.trigger,this,"uiAction:threadUpvote"));b.on("vote:down",_.bind(this.trigger,this,"uiAction:threadDownvote"));b.render();
this.updateDom(function(){$("#thread-votes").append(b.el)})},200),initThreadSubscribe:function(){this.threadSubscribeButton=new z({session:this.session,thread:this.thread,el:$("#thread-subscribe-button")[0]})},renderStreamingToggle:function(){var b=this;if(b.thread.get("hasStreaming")){var a=$(DISQUS.renderBlock("realtimeToggleButton"));$(a).on("click",f(function(){b.toggleStreamingRealtime()}));b.updateDom(function(){$("#realtime-toggle").empty();$("#realtime-toggle").append(a[0])})}},toggleStreamingRealtime:function(){var b=
$("#realtime-toggle a.btn");this.states.streamingPaused?(this.states.streamingPaused=!1,b.addClass("pause")):(this.states.streamingPaused=!0,b.removeClass("pause"))},updateThreadVotes:function(){$("#thread-votes [data-role=like-count]").text(this.thread.get("likes"))},updateThreadUserScore:function(){var b=this.thread.get("userScore"),a=$("#thread-votes [data-role=vote-button]");a.removeClass("upvoted").removeClass("downvoted");b>0?a.addClass("upvoted"):b<0&&a.addClass("downvoted")},updatePostCount:function(){$("#post-count").html(DISQUS.renderBlock("postCount",
{count:this.thread.get("posts")}))},swapMain:function(b){var c=this,d=this.$el.find("#main-nav [data-nav=conversation]").parent("li");b!=="conversation"?d.attr("data-dropdown","disabled"):_.defer(function(){d.attr("data-dropdown","enabled")});c.updateDom(function(){c.states.realtimeIndicatorsCreated&&b!="conversation"&&(a.sendHostMessage("realtime.hideNorth"),a.sendHostMessage("realtime.hideSouth"));var d=c[b];d&&!d.isRendered&&(c.freeze(!0),d.on("render:all",_.once(function(){c.freeze(!1)})),d.show());
c.$el.find("[data-role=main]").hide();c.$el.find("[data-role=main]#"+b).show();c.prevSection=c.currentSection;c.currentSection=b});c.trigger("uiAction:navigate",b)},returnToConversation:function(){this.mainNav.navTo("conversation");var b=this.conversationPosition,c=b&&b.pageOffset;c&&this.updateDom(function(){_.delay(function(){a.sendHostMessage("scrollTo",{top:c,relative:"window",force:!0})},100)},this)},setupNavigation:function(){var b=this;b.globalNav=new V({el:b.$el.find("#global-nav")[0]});b.mainNav=
new V({el:b.$el.find("#main-nav")[0]});b.globalNav.on("nav",function(a){b.updateDom(function(){var c=b.$el.find("#form"),d=b.$el.find("#main-nav");switch(a){case "conversation":c.show();d.show();b.swapMain(b.prevSection||a);break;case "reactions":c.hide(),d.hide(),b.swapMain(a)}})});b.mainNav.on("nav",function(a){b.updateDom(function(){b.swapMain(a)})})},renderLayout:function(){function b(b){return function(d){d.preventDefault();var e=$(d.currentTarget);e.addClass("busy");c.thread[b].more({success:function(){if(b===
"posts")c.once("postsRendered",function(){e.removeClass("busy")});else e.removeClass("busy")},error:function(){e.removeClass("busy")}});a.sendHostMessage([b,".paginate"].join(""))}}var c=this;c.setElement($(DISQUS.renderBlock("layout",{thread:_.extend(c.thread.toJSON(),{showReactions:c.forum.get("settings").hasReactions}),order:c.thread.posts.order})).appendTo("body"));var d=c.$el;c.setupNavigation();_.each(["posts","reactions"],function(a){d.delegate("[data-action=more-"+a+"]","click",b(a))});c.updateDom();
a.sendHostMessage("mainViewRendered")},renderForm:function(){if(this.thread.get("isClosed"))return void this.alert(l("Comments for this thread are now closed."));if(!this.session.get("canReply"))return void this.session.on("change:id",function C(){this.session.off("change:id",C);this.renderForm()},this);var b=new x({thread:this.thread,session:this.session});b.render();this.updateDom(function(){$("#form").prepend(b.el);b.resize()},this)},toggleNoPosts:function(){this.updateDom(function(){this.thread.posts.models.length?
$("#no-posts").hide():$("#no-posts").show()},this)},handleShowProfile:f(function(b){this.showProfile($(b.currentTarget).attr("data-user"))}),handleSort:f(function(b){b=$(b.currentTarget).attr("data-sort");this.$el.find('[data-role="post-sort"]').replaceWith(DISQUS.renderBlock("postSort",{order:b}));this.thread.posts.order=b;this.thread.posts.fetch({reset:!0});$("#posts [data-role=more]").hide();$("#no-posts").hide();$("#post-list").addClass("loading").empty()}),closeThread:f(function(){this.thread.close({success:_.bind(a.sendHostMessage,
a,"reset"),error:_.bind(this.alert,this,"An error occurred while closing thread. Please try again.","error")})}),openThread:f(function(){this.thread.open({success:_.bind(a.sendHostMessage,a,"reset"),error:_.bind(this.alert,this,"An error occurred while opening thread. Please try again.","error")})}),findClosestThumbnailSize:function(){var b=document.body.offsetWidth;if(this.loadedThumbnailWidth)return this.loadedThumbnailWidth;var a=this.MEDIA_PERSISTED_WIDTHS,c=a.length;this.loadedThumbnailWidth=
_.find(a,function(d,e){return e+1===c||Math.abs(a[e+1]-b)>Math.abs(a[e]-b)})},redrawPosts:function(){var b=this;b.postViews={};b.on("postsRendered",function C(){b.off("postsRendered",C);_.each(x.open,function(a,c){var d=b.postViews[c];d&&(d=d.getReplyView(),d.textarea.set(a.textarea.get()),a.isOpen()?d.show():d.hide())})});b.addPosts(b.thread.posts,{clearDom:!0})},createPostView:function(b){var a,c=b.get("parent");c&&(a=(c=this.thread.posts.get(c))&&this.postViews[c.cid]);a=new H({parent:a,model:b,
thread:this.thread,session:this.session,created:b.created});this.postViews[b.cid]=a;a.render();return a},addPostsIncremental:function(){var b=[],a=!1,c=!1,d=2,e=0,f=0,g;g=window.performance&&window.performance.now?function(){return window.performance.now()}:function(){return new Date};return function ia(){var i=this;if(i.postsShouldClearDom)a=!0,i.postsShouldClearDom=!1,b=[];var j=!!i.postsToAppend.length,k=j?i.postsToAppend:i.postsToPrepend;if(k.length){for(var l=30,n=function(a){a.get("isRealtime")&&
(c=!0);b.push(i.createPostView(a))};d>0;){var m=g(),o=k.splice(0,d);if(!o.length)break;_.each(o,n);m=g()-m;if(m<=0)break;f+=m;l-=m;e+=o.length;d=Math.round(l*e/f)}d=Math.round(Math.max(24*e/f,2));if(!k.length)i.updateDom(function(){var d=$("#post-list");a&&(d.empty(),a=!1);c&&(i.removeOldPosts(),c=!1);d.removeClass("loading");if(b.length){_.each(b,function(b){b.visible=!0});var e=_.groupBy(b,function(b){return!!b.parent});b=[];_.each(e[!0],function(b){b.parent.attachChild(b)});e=_.pluck(e[!1],"el");
j?d.append(e):d.prepend(e)}!i.postsToPrepend.length&&!i.postsToAppend.length&&i.trigger("postsRendered")}),i.nextProcess=null;if(i.postsToPrepend.length||i.postsToAppend.length)i.nextProcess=_.defer(_.bind(ia,i))}else i.nextProcess=null,$("#post-list").removeClass("loading")}}(),postsShouldBePrepended:function(b){b=b.length&&b[0];return!!b&&(b.created||!b.id||b.get("isRealtime")||b.requestedByPermalink)},hasQueuedPosts:function(){return this.postsToAppend.length||this.postsToPrepend.length},addPosts:_.decorate(Backbone.collectionAddNormalizer(m.PostCollection,
c.Post),function(b,a,c){var d=this;if(c.clearDom)d.postsToAppend=[],d.postsToPrepend=[],d.postsShouldClearDom=!0;if(d.postsShouldBePrepended(b)){var e=[];_.each(b,function(b){var a=b.get("parent");a&&d.thread.posts.get(a)?d.postsToPrepend.push(b):e.push(b)});d.postsToPrepend=e.concat(d.postsToPrepend)}else d.postsToAppend=d.postsToAppend.concat(b);if(!d.nextProcess)d.nextProcess=_.defer(_.bind(d.addPostsIncremental,d))}),calculateImageOffsets:function(){var b=[];$("img[data-src]").each(function(a){var a=
$(a),c=a.offset();(c.top||c.left)&&b.push({offset:c.top,element:a,relatedPost:a.attr("data-post")})});this.deferredImages=b},processDeferredImages:function(b){this.deferredImages||this.calculateImageOffsets();var a=this.deferredImages.length;if(a&&(b=b.pageOffset+b.height*2-b.frameOffset.top,!(b<0))){for(var c=0;c<a;++c){var d=this.deferredImages[c];if(d.offset<=b){var e=d.element,f=e.attr("data-src");f&&(d.relatedPost&&(d=_.bind(this.onPostImageReady,this,d),e.on("load",d,this),e.on("error",d,this)),
e.attr("src",f),e.removeAttr("data-src"))}else break}this.deferredImages=this.deferredImages.slice(c)}},onPostImageReady:function(b){var a=k.postViews,b=b.relatedPost;a.hasOwnProperty(b)&&a[b].manageMessageHeight();this.updateDom()},showProfile:function(b){this.switches.enabled("next_profile_modal")?this.showProfileModal(b):this.showProfileTab(b)},showProfileModal:function(b){Modernizr.sessionstorage&&sessionStorage.setItem("profile.session",i.stringify(this.session.user.toJSON()));$(document).trigger("mouseout");
b={userId:b,language:this.language};if(DISQUS.browser.mobile)window.open("about:blank",this.profileWindowName,"width=320,height=480"),b.windowName=this.profileWindowName;a.sendHostMessage("profile.show",b)},showProfileTab:function(b){if(b=c.UniqueModel.get(c.User,b)){this.profile&&this.profile.remove();var d=this.profile=new L({user:b,session:this.session});this.freeze(!0);this.updateDom(function(){this.mainNav.clear();$("#profile").empty().append(d.el);this.swapMain("profile")},this);d.on("close",
function(){this.returnToConversation();this.updateDom(function(){d.remove()},this)},this);d.on("render:all",_.once(function(){this.freeze(!1)}),this);a.sendHostMessage("scrollTo",{top:0})}},removePost:function(b){var a=this;if(a.hasQueuedPosts())a.on("postsRendered",function J(){a.off("postsRendered",J);a.removePost(b)});else{var c=a.postViews[b.cid];c&&(c.remove(),delete a.postViews[b.cid])}},removeOldPosts:function(){if(this.switches&&this.switches.enabled("next_realtime_cap")){var b=_.size(this.postViews)-
this.STREAMING_MAX_VISIBLE;if(!(b<=0))for(var a=this.thread.posts.sortBy(function(b){return moment(b.get("createdAt")).valueOf()}),c,d=0,e=0;d<a.length&&e<=b;d++)if((c=this.postViews[a[d].cid])&&c.childrenNode.children().length===0)this.thread.posts.remove(a[d]),e+=1}},resize:function(){var b=$("body").height();if(!this._frozen||!(this._lastHeight&&this._lastHeight>b))this._lastHeight=b,a.sendHostMessage("resize",{height:b})},freeze:function(b){this._frozen=!!b;this._frozen===!1&&this.resize()},getPostView:function(b){return this.postViews[b]},
windowOpen:function(b,a,c){window.open(b,"_blank","width="+a+",height="+c)},authenticate:function(b){var a=this.authServices[b];if(!a)return void DISQUS.log("Unknown authentication service: "+b);if(_.isFunction(a))return a.call(this);k.trigger("uiAction:openLogin",b);this.windowOpen(DISQUS.serialize(a.url,{forum:this.thread.forum.get("id")}),a.width,a.height)},handleAuth:f(function(b){this.authenticate(g(b.target,"auth"))}),authServices:{disqus:{url:DISQUS.urls.login,width:460,height:355},twitter:{url:DISQUS.urls.oauth.twitter,
width:650,height:680},facebook:{url:DISQUS.urls.oauth.facebook,width:550,height:300},google:{url:DISQUS.urls.oauth.google,width:650,height:440},sso:function(){var b=parseInt(this.config.sso.width||"800",10),c=parseInt(this.config.sso.height||"500",10),d=window.open(this.config.sso.url,"_blank","width="+b+",height="+c);(function J(){e.isWindowClosed(d)?a.sendHostMessage("reload"):_.delay(J,500)})()}},verifyEmail:f(function(){var b=DISQUS.serialize(DISQUS.urls.verifyEmail,{f:this.forum.id});window.open(b,
"_blank","width=460,height=355")}),getAudienceSyncUrl:_.memoize(function(){var b={client_id:this.config.apiKey,response_type:"audiencesync",forum_id:this.forum.id};if(window.location.protocol==="https:")b.ssl=1;return DISQUS.serialize(DISQUS.urls.authorize,b)}),audienceSync:f(function(){this.windowOpen(this.getAudienceSyncUrl(),460,355)})});j.getInstance=function(){return k};_.extend(j.prototype,r);_.extend(j.prototype,o);var n=Backbone.View.extend({updateDom:function(b,a){var c=j.getInstance();c&&
c.initialized?c.updateDom(b,a):_.isFunction(b)&&b.call(a)},resize:function(){var b=j.getInstance();b&&b.initialized&&b.resize()}}),t=n.extend({events:{"click [data-action=share:twitter]":"_onShare","click [data-action=share:facebook]":"_onShare"},_onShare:f(function(b){if((b=g(b.target,"share"))&&this.sharers[b])k.trigger("uiAction:threadShare",b),this.share(b)}),_shareUrl:function(){return this.model.url()}});_.extend(t.prototype,r);var u=n.extend({initialize:function(b){_.extend(this,b)},events:{"click [data-action=upvote]":"upvote"},
render:function(){this.setElement($(DISQUS.renderBlock("threadVotes",{thread:this.thread.toJSON(),user:this.session.toJSON()})))},upvote:f(function(){this.vote(1)}),vote:function(b){this.trigger(b===1?"vote:up":"vote:down");var a=this.thread.get("userScore")===b,c;this.thread.vote(a?0:b);a||(c=this.$el.find(".dropdown"),_.defer(function(){c.addClass("open")}))},remove:function(){this.off();Backbone.View.prototype.remove.call(this)}}),z=n.extend({events:{"click [data-action=subscribe]":"subscribe",
"keydown #thread-subscribe-email":"subscribeKeypress"},initialize:function(b){this.thread=b.thread;this.session=b.session;this.thread.on("change:userSubscription",this.updateStatus,this);this.updateStatus();this._boundDocumentClickHandler=_.bind(this._documentClickHandler,this)},updateStatus:function(){this.thread.get("userSubscription")?this.$el.addClass("subscribed"):this.$el.removeClass("subscribed")},subscribe:f(function(){var b=this.thread.get("userSubscription");this.session.isAnonymous()&&
!b?this.showForm():this.thread.subscribe(!b)}),showForm:function(){var b=this;this._unbindDocumentClickHandler();_.defer(function(){$(document.body).on("click",b._boundDocumentClickHandler)});b.$el.addClass("show-form").find("input")[0].focus()},_documentClickHandler:function(b){b.target.id!=="thread-subscribe-email"&&this.hideForm()},_unbindDocumentClickHandler:function(){$(document.body).off("click",this._boundDocumentClickHandler)},hideForm:function(){this._unbindDocumentClickHandler();this.$el.removeClass("show-form").find("input")[0].blur()},
subscribeKeypress:function(b){var a=this.$el.find("input");a.removeClass("alert error");if(b.key==="Esc"||b.keyCode===27)return void this.hideForm();if(!(b.key!=="Enter"&&b.keyCode!==13))b=b.target.value,e.validateEmail(b)?(this.hideForm(),this.thread.subscribe(!0,b)):a.addClass("alert error")}}),A=n.extend({initialize:function(b){_.extend(this,b)},render:function(){var b=DISQUS.renderBlock("userMenu",{user:this.session.toJSON(),thread:this.thread.toJSON(),logoutUrl:this.logoutUrl,feedbackUrl:this.getSurveyMonkeyUrl()});
this.updateDom(function(){this.$el.html(b)},this)},getSurveyMonkeyUrl:function(){var b=this.referrerUrl,a=this.session.user.id;return"https://www.surveymonkey.com/s/5RBPTTZ?c="+encodeURIComponent((a?[a,b]:[b]).join(";"))}}),w=new QueuedStorage(Modernizr.localstorage?window.localStorage:DISQUS.next.utils.hashStorage,5,"drafts.queue"),v=function(b){if(!b)throw Error("Cannot instantinate MediaStore without a valid storageKey!");this._storageKey=b;this._store=Modernizr.localstorage?window.localStorage:
DISQUS.next.utils.hashStorage};_.extend(v.prototype,{getItems:function(){var b=this._store.getItem(this._storageKey);return b&&i.parse(b)||{}},clear:function(){this._store.removeItem(this._storageKey)},getItem:function(b){return this.getItems()[b]},setItem:function(b,a){var c=this.getItems();c[b]=a;this._store.setItem(this._storageKey,i.stringify(c));return a},removeItem:function(b){var a=this.getItems();if(b in a)return delete a[b],this._store.setItem(this._storageKey,i.stringify(a)),!0;return!1}});
var G=n.extend({events:function(){var b={"click [data-action=attach]":"_attachMedia"};window.FormData&&_.extend(b,{dragover:"_dragOn",dragenter:"_dragOn",dragleave:"_dragOff",dragexit:"_dragOff",drop:"_drop"});return b},initialize:function(b){this.owner=b.owner;this.parent=b.parent;this.url=b.url},setElement:function(){var b=n.prototype.setElement.apply(this,arguments);this.$dragPlaceholder=this.$el.find("[data-role=drag-drop-placeholder]");this.$mediaSelector&&this.$mediaSelector.off();this.$mediaSelector=
this.$el.find("input[type=file][data-role=media-upload]");this.$mediaSelector.on("change",_.bind(this._selectorChange,this));return b},_toggleDragPlaceholder:_.throttle(function(b){b?this.$dragPlaceholder.show():this.$dragPlaceholder.hide()},50),_selectorChange:function(b){this.uploadMedia(b.target.files);if(k.switches.enabled("next_dragdrop_nag")&&b.target.files&&Modernizr.localstorage&&!window.localStorage.getItem("usedDragDrop"))this.owner.alert(l("Did you know you can drag and drop images too? Try it now: drag images below.")).on("dismiss",
function(){window.localStorage.setItem("usedDragDrop","1")})},_dragOn:function(b){b.stop();this._toggleDragPlaceholder(!0);this.owner.owner.$el.addClass("expanded")},_dragOff:function(b){b.stop();this._toggleDragPlaceholder(!1)},_drop:function(b){b.stop();window.localStorage.setItem("usedDragDrop","1");this._toggleDragPlaceholder(!1);this.uploadMedia(b.dataTransfer.files)},_attachMedia:function(b){b.stop();this.$mediaSelector[0].click()},_uploadMediaModern:function(b){for(var a=this,c=new FormData,
d=0,f=b[d];f;f=b[++d])f.type.match(/^image\//)&&c.append("attachment",f);c.append("json","true");this.parent&&c.append("id",this.parent.id);var g=e.CORS.request("POST",this.url,function(){if(!(g.readyState!==void 0&&(g.readyState!==4||g.status!==200))){var b=i.parse(g.responseText);b.success?a.owner.addMedia(b.media):a.owner.alert(b.message,"error")}},function(){var b=l("Unfortunately your image upload failed. Please verify that your image is under 2MB. If you continue seeing this error, please try again later.");
g.status===413&&(b=l("Sorry, but the file you submitted is larger than 2 MB. Please make it smaller and try again."));a.owner.alert(b,"error")});g.withCredentials=!0;g.send(c)},_uploadMediaLegacy:function(){var b=this,a=document.createElement("iframe"),c=document.createElement("form"),d=this.$mediaSelector[0];$(d).off();var e=$(d.cloneNode(!0));d.parentNode.replaceChild(e[0],d);e.on("change",_.bind(this._selectorChange,this));this.$mediaSelector=e;a.style.display="none";a.name="uploadFrame"+ +new Date;
c.style.display="none";c.target=a.name;c.action=this.url;c.method="post";c.appendChild(a);c.appendChild(d);if(this.parent)a=document.createElement("input"),a.type="hidden",a.name="id",a.value=this.parent.id,c.appendChild(a);c.enctype="multipart/form-data";c.encoding="multipart/form-data";var f=function(a){a=i.parse(a.data);a.name==="upload"&&($(c).remove(),$(window).off("message",f),a.data.success?b.owner.addMedia(a.data.media):b.owner.alert(a.data.message,"error"))};$(window).on("message",f);this.updateDom(function(){this.$el.append(c);
c.submit()},this)},uploadMedia:function(b){this.uploadMedia=this["_uploadMedia"+(window.FormData?"Modern":"Legacy")];return this.uploadMedia(b)}}),q=n.extend({events:{"click [data-action=detach]":"_detachMedia"},initialize:function(b){this.alert=_.bind(b.owner.alert,b.owner);this.owner=b.owner;this.parent=b.parent;this.urls=b.urls;this.uploader=new G({owner:this,parent:this.parent,url:this.urls.add})},setElement:function(){var b=n.prototype.setElement.apply(this,arguments);this.$list=this.$el.find("ul[data-role=media-preview-list]");
return b},clear:function(){this.$el.addClass("empty");this.$list.empty();this.owner.mediaStore&&this.owner.mediaStore.clear()},_detachMedia:function(b){b.stop();this.updateDom(function(){this.removeMedia($(b.target).closest("li"))},this)},addMedia:function(b){var a=$(DISQUS.renderBlock("mediaUpload",b));this.owner.mediaStore.setItem(b.location,b);a.attr("data-media-id",b.location);this.updateDom(function(){this.$list.append(a);this.$el.removeClass("empty")},this)},removeMedia:function(b){var a=this.owner.mediaStore.getItem(b.attr("data-media-id"));
if(a){var c={media:i.stringify(a)};if(this.parent)c.id=this.parent.id;(new Image).src=DISQUS.serialize(this.urls.remove,c,!0);this.owner.mediaStore.removeItem(a.location);this.updateDom(function(){b.remove();this.$list.children().length||this.$el.addClass("empty")},this)}}}),x=n.extend({events:{"click [name=author-register]":"expandRegister","click input[name=author-guest]":"managePassword"},initialize:function(b){this.session=b.session;this.parent=b.parent;this.thread=b.thread;this.parentView=b.parentView;
this.thread.on("change:id",function(){this.restoreDraft();if(this.thread.forum.get("settings").allowMedia)this.mediaStore=new v(this.storageKey("media"))},this);this.session.on("change:id change:audienceSyncVerified",this.redraw,this);this.parent&&(x.open[this.parent.cid]=this);this.textarea=Modernizr.contenteditable&&!DISQUS.browser.mobile&&(!window.opera||!window.opera.version)?new y({thread:this.thread}):new D;if(this.thread.forum.get("settings").allowMedia){if(b=this.storageKey("media"))this.mediaStore=
new v(b);this.mediaUploads=new q({owner:this,parent:this.parent,urls:{add:this.thread.get("uploadAdd"),remove:this.thread.get("uploadRemove")}})}},storageKey:function(b){if(!this.thread.id)return null;return[b||"drafts","thread",this.thread.id,"parent",this.parent?this.parent.id:0].join(":")},saveDraft:function(){this.storageKey()!==null&&w.setItem(this.storageKey(),i.stringify([this.textarea.get(),(new Date).getTime()]))},getDraft:function(){if(this.storageKey()===null)return null;var b=w.getItem(this.storageKey());
if(!b)return null;b=i.parse(b);if(b[1]+86400>(new Date).getTime())return b[0];w.removeItem(this.storageKey());return null},restoreDraft:function(){this.textarea.set(this.getDraft())},updateAvatar:function(){this.$el.find("[data-role=user-avatar]").attr("src",this.session.user.get("avatar").cache)},expandGuestForm:function(){this.$el.find("[data-role=guest-details]").addClass("expanded")},expandRegister:function(){this.$el.toggleClass("register")},redraw:function(){var b=this.$el.hasClass("expanded"),
a=this.el,c=this.$el.find("textarea").val();this.render();this.$el.find("textarea").val(c);b&&this.$el.addClass("expanded");$(a).parent().length!==0&&this.updateDom(function(){a.parentNode.replaceChild(this.el,a)},this)},render:function(){var b=this,a=b.getDraft()||"";this.setElement($(DISQUS.renderBlock("form",{message:a,parent:b.parent?b.parent.toJSON():null,user:b.session.toJSON(),forumName:b.thread.forum.get("name"),audienceSyncRequired:b.session.needsAudienceSyncAuth(b.thread.forum),apiKey:k.config&&
k.config.apiKey||"",mediaList:this.mediaStore?_.values(this.mediaStore.getItems()):[],allowAnonPost:b.thread.forum.get("settings").allowAnonPost,allowMedia:b.thread.forum.get("settings").allowMedia,showNewLogin:b.thread.forum.get("settings").showNewLogin})));this.$el.find("form").on("submit",_.bind(this.submitForm,this));var c=this.textarea;c.setElement(b.$el.find("textarea")[0]);c.render();c.on("keychange",_.debounce(this.saveDraft,500),this);c.$el.on("focus",function(){b.$el.addClass("expanded focus");
_.delay(_.bind(b.resize,b),200)});c.$el.on("blur",function(){c.get()||b.$el.removeClass("focus")});this.mediaUploads&&(this.mediaUploads.setElement(this.$el.find("[data-role=media-preview]")[0]),this.mediaUploads.uploader.setElement(this.$el.find("[data-role=textarea]")[0]));b.$el.find("input[name=author-name]").on("focus",function(){b.expandGuestForm()});b.show();b.session.get("mustVerifyEmail")&&b._alertMustVerify()},resize:function(){this.textarea.resize()},focus:function(){this.textarea.focus()},
clear:function(){var b=this;b.textarea.clear();b.$el.removeClass("expanded");b.mediaUploads&&b.mediaUploads.clear();_.delay(function(){b.resize()},200);b.parent?b.hide():b.$el.removeClass("expanded");this.storageKey()&&w.removeItem(this.storageKey())},restore:function(b){var a=this;a.textarea.set(b.get("raw_message"));_.delay(function(){a.resize()},200);a.parent&&a.show()},managePassword:function(){var b=this.$el,a=b.find("input[name=author-guest]");if(b=b.find("input[name=author-password]"))b[a.attr("checked")?
"hide":"show"](),b.attr("value","")},_alertMustVerify:function(b){this.alert(DISQUS.interpolate(l("%(forumName)s requires you to %(verifyEmail)s before posting"),{forumName:this.thread.forum.get("name"),verifyEmail:'<a href="#" data-action="verify-email">'+l("verify your email address")+"</a>"}),{safe:!0,type:b?"error":"warn"})},getPassword:function(){var b=this.$el.find("input[name=author-password]");if(b.length)return b.val();return null},submitForm:function(b){function a(b){b=b.response;/Invalid email address/i.test(b)?
d.alert(l("Invalid email address."),"error"):/Missing required argument\: \'email\'/i.test(b)?d.alert(l("Please enter an email address."),"error"):/'Please enter your name.']/i.test(b)?d.alert(l("Please enter your name."),"error"):/password/i.test(b)?d.alert(l("Please enter the password."),"error"):/The e-mail address you specified is already in use./i.test(b)?d.alert(l("The e-mail address you specified is already in use. (Do you already have an account?)"),"error"):/Unable to create user/i.test(b)?
d.alert(l("That email address is already registered with a Disqus account. Log in or enter another email."),"alert"):d.alert(b,"error")}function c(){d.alert(l("Your account was created successfully."),{success:!0});k.trigger("uiAction:finishRegistrationEmbed")}var d=this;b&&b.preventDefault&&b.preventDefault();if(this._alert)this._alert.remove(),this._alert=null;b=d.$el.find("input[name=author-register]");b=b.length&&b[0].checked;k.forum.get("settings").showNewLogin&&(b=d.$el.find("input[name=author-guest]"),
b=b.length&&!b[0].checked);if(d.session.isAnonymous()&&b)return d.session.register({name:d.$el.find("input[name=author-name]").val(),email:d.$el.find("input[name=author-email]").val(),password:d.getPassword()},{error:a,success:c}),null;return d.createPost()},createPost:function(){var b=this,a={thread:b.thread.id,depth:b.parent?b.parent.get("depth")+1:0,parent:b.parent?b.parent.id:null,raw_message:b.textarea.get()};b.session.isRegistered()?a.author_id=b.session.user.id:_.extend(a,{author_name:b.$el.find("input[name=author-name]").val(),
author_email:b.$el.find("input[name=author-email]").val()});var d=new DISQUS.next.models.UniqueModel(DISQUS.next.models.Post);if(!d.set(a,{validate:!0}))return void b.alert(d.validationError,"error");var e=null,f=function(a,c){if(c.code===19){if(e)return e.reload();e=new O;e.render();var h=k.getPostView(d.cid);h.el.parentNode.insertBefore(e.el,h.el);e.start();e.on("submitted",function(){d.save({recaptcha_challenge_field:e.getChallenge(),recaptcha_response_field:e.getResponse()},{success:function(){e.remove()}})})}else c.code===
12&&/verify/.test(c.response)?b._alertMustVerify(!0):_.isString(c.response)&&b.alert(c.response,"error"),b.thread.posts.remove(d),b.restore(d),b.thread.incrementPostCount(-1)};d.on("error",f);d.on("sync",function ga(){b.thread.trigger("create",d);d.off("error",f);d.off("sync",ga)});d.save(a);d.author=b.session.isRegistered()?b.session.user:new c.UniqueModel(c.User,{id:md5(a.author_email),name:a.author_name,email:a.author_email});b.thread.incrementPostCount(1);d.created=!0;b.thread.posts.add(d);b.clear();
k.trigger("uiAction:createPost",d);return d},remove:function(){this.updateDom(function(){this.$el.remove()},this);this.parent&&(delete x.open[this.parent.cid],this.typingStop())},toggle:function(){this.isOpen()?this.hide():this.show()},show:function(){var b=this;b.updateDom(function(){b.$el.removeClass("hidden")});b.typingStart()},hide:function(){var b=this;b.updateDom(function(){b.$el.addClass("hidden")});b.typingStop()},isOpen:function(){return!this.$el.hasClass("hidden")},typingStart:function(){var b=
this;b.parent&&j.getInstance().isRealtimeEnabled()&&_.delay(function(){var a=DISQUS.urls.realertime+"/api/2/typing/",c;e.attempt(function(){c=e.CORS.request("POST",a)});if(c===null)return void DISQUS.log("CORS is not supported by this browser.");var d=i.stringify({typing:!0,forum_url:b.thread.get("forum"),thread_id:b.thread.get("id"),user_id:b.session.user.id||0,parent_post_id:b.parent.get("id")});e.attempt(function(){c.send(d)})},500)},typingStop:function(){var b=this;b.parent&&j.getInstance().isRealtimeEnabled()&&
_.delay(function(){var a=DISQUS.urls.realertime+"/api/2/typing/",c;e.attempt(function(){c=e.CORS.request("POST",a)});if(c===null)return void DISQUS.log("CORS is not supported by this browser.");var d=i.stringify({typing:!1,forum_url:b.thread.get("forum"),thread_id:b.thread.get("id"),user_id:b.session.user.id||0,parent_post_id:b.parent.get("id")});e.attempt(function(){c.send(d)})},500)}});_.extend(x.prototype,o);x.open=x.open||{};var N=n.extend({initialize:function(b){this.post=b.post;this.textarea=
new D},render:function(){this.setElement($(DISQUS.renderBlock("edit",{post:this.post.toJSON()})));this.$el.find("form").on("submit",_.bind(this.submitForm,this));var b=this.textarea;b.setElement(this.$el.find("textarea")[0]);b.render()},resize:function(){this.textarea.resize()},submitForm:function(b){b&&b.preventDefault()&&b.preventDefault();var b={raw_message:this.textarea.get()},a=this.post.validate(b);if(a!==void 0)return alert(a);this.trigger("submitted");this.post.save(b,{success:function(){}})},
remove:function(){this.updateDom(function(){this.$el.remove()},this)}}),H=n.extend({initialize:function(b){this.MAX_POST_HEIGHT=374;this.thread=b.thread;this.session=b.session;this.created=!!b.created;this.model.on("destroy",this.removeAsDeleted,this);this.model.on("spam",this.removeAsDeleted,this);this.model.on("change:message",this.stopLoading,this);this.model.on("change:points",this.updatePoints,this);this.model.on("change:userScore",this.updateVotes,this);this.model.usersTyping.on("add remove reset",
this.updateTypingCount,this);this.session.on("change:id",this.updateEditHide,this);this.session.on("change:id",this.updateFooter,this);this.session.on("change:id",this.updateMenu,this);this.session.on("change:id",this.updateVotes,this);this.model.on("change",function(){var b=this.model.changedAttributes();(b.id||b.message)&&this.redraw()},this);this.edit=this.reply=null;this.parent=b.parent;this.trackPosition=!1;this.offset={top:-1,height:-1};this.dim={height:-1,width:-1};j.getInstance().on("domReflow",
function(){if(!this.trackPosition||!this.visible)this.offset={top:-1,height:-1},this.dim={height:-1,width:-1};else{var b=this.contentNode;this.offset=b.offset();this.dim=b.dim()}},this);this.isCollapseAllowed=!0},updateTypingCount:function(){this.typingUserView&&this.typingUserView.render()},stopLoading:function(){this.contentNode.find(".loading").removeClass("loading")},updateRelativeTime:function(){this.contentNode.find("[data-role=relative-time]").text(this.model.getRelativeCreatedAt())},updateVotes:function(){var b=
this.model,a=this.contentNode.find("[data-role=voting]"),c=DISQUS.renderBlock("postVotes",{session:{id:this.session.user.id},post:{userScore:b.get("userScore"),points:b.get("points"),likes:b.get("likes"),dislikes:b.get("dislikes")}});this.updateDom(function(){a.html(c)})},updateEditHide:function(){var b=this.contentNode.find("[data-role=edit-hide]"),a=DISQUS.renderBlock("postEditHide",{post:{author:{id:this.model.author.id}},session:{id:this.session.user.id}});this.updateDom(function(){b.html(a)})},
updateFooter:function(){var b=this.contentNode.find("footer"),a=DISQUS.renderBlock("postFooter",{post:this.model.toJSON(),session:this.session.toJSON(),thread:this.thread.toJSON()});this.updateDom(function(){b.html(a)})},updateMenu:function(){var b=this.contentNode.find("[data-role=menu]"),a=DISQUS.renderBlock("postMenu",{session:this.session.toJSON(),post:this.model.toJSON()});this.updateDom(function(){b.html(a)})},updatePoints:function(b){var a=function(b){_.delay(function(){b.addClass("update");
_.delay(function(){b.removeClass("update")},1E3)},500)};this.contentNode.find("[data-role=likes], [data-role=dislikes]").each(function(c){var c=$(c),d=c.html(),e=b.get(c.attr("data-role")).toString();d!==e&&(c.removeClass("count-"+e),c.removeClass("count-"+d),c.html(e),a(c))})},getMessageContainer:function(){if(!this.messageContainer||!this.messageContainer.length)this.messageContainer=this.contentNode.find("[data-role=message-container]");return this.messageContainer},getMessageContent:function(){if(!this.messageContent||
!this.messageContent.length)this.messageContent=this.contentNode.find("[data-role=message-content]");return this.messageContent},getMoreButton:function(){if(!this.seeMoreButton||!this.seeMoreButton.length)this.seeMoreButton=this.contentNode.find("[data-action=post-expand]");return this.seeMoreButton},getShadowEl:function(){if(!this.shadowNode||!this.shadowNode.length)this.shadowNode=this.contentNode.find("[data-role=message-shadow]");return this.shadowNode},manageMessageHeight:function(){var b=this.getMessageContent(),
a=this.MAX_POST_HEIGHT;j.getInstance().switches.enabled("next_comments_truncation_enabled")&&this.isCollapseAllowed&&(b&&b.length&&b.height()>a*1.5&&!this.$el.hasClass("collapsed")?this.collapseMessage():this.expandMessage(!0))},collapseMessage:function(){var b=this.getMessageContainer(),a=this.MAX_POST_HEIGHT;b&&b.length&&!b.hasClass("post-message-collapse")&&(this.updateDom(function(){b.addClass("post-message-collapse");b.height(a)}),this.addMoreButton())},expandMessage:function(b){if(this.messageContainer&&
this.messageContainer.length){var a=this.getMessageContainer();this.updateDom(function(){a.removeClass("post-message-collapse");a.css("height",null)});this.removeMoreButton();if(b!==!0)this.isCollapseAllowed=!1}},addMoreButton:function(){var b=this.getMoreButton(),a=this.getShadowEl();this.updateDom(function(){a.removeClass("hidden");b.removeClass("hidden")})},removeMoreButton:function(){var b=this.getMoreButton(),a=this.getShadowEl();this.updateDom(function(){b.addClass("hidden");a.addClass("hidden")})},
markSeen:function(){function b(d){var e,f;if(!d)return!1;if(a.dim.height<=0||a.dim.width<=0)return!1;e=a.offset.top+d.frameOffset.top;f=(f=e>d.pageOffset)&&e+a.dim.height<=d.pageOffset+d.height;if(!f)return!1;a.contentNode.addClass("seen");_.delay(function(){a.contentNode.removeClass("seen");a.contentNode.removeClass("new")},1E4);a.trackPosition=!1;c.off("scroll",b);return!0}var a=this,c=j.getInstance();c.off("postsRendered",a.markSeen);if(!b(c.position))c.on("scroll",b,a)},render:function(){var b=
this,a=b.parent&&b.parent.model,c=k.loadedThumbnailWidth,d=k.MAX_MEDIA_HEIGHT,e=k.forum.get("settings").showNewMedia;e||(d=c=75);b.setElement($(DISQUS.renderBlock("post",{post:b.model.toJSON(),session:b.session.toJSON(),thread:b.thread.toJSON(),loading:!b.model.id,created:b.created,parentAuthorName:a?a.author.get("name"):null,thumbnailWidth:c,thumbnailHeight:d,showNewMedia:e})));b.contentNode=b.$el.find("[data-role=post-content]");b.childrenNode=b.$el.find("[data-role=children]");b.messageNode=b.contentNode.find("[data-role=message]");
this.highlightSyntax();if(b.model.get("isRealtime"))j.getInstance().switches.enabled("next_realtime_anim_disabled")?b.contentNode.removeClass("new"):(b.trackPosition=!0,k.on("postsRendered",b.markSeen,b));k.on("postsRendered",_.once(function(){_.defer(function(){var a=b.$el.find("[data-role=realtime-notification:"+b.model.id+"] .realtime-replies");b.manageMessageHeight();b.typingUserView=new W({parentView:b,model:b.model,el:a})})}));b.processMentions();b.bindDomEvents();if(a&&!a.get("isDeleted"))b.contextCard=
M.create({post:this.parent.model,targetElement:this.$el.find("[data-role=parent-link]")})},highlightSyntax:function(){var b=this.contentNode.find("pre code");b.length&&b.each(function(b){e.syntaxHighlighter.highlight(b)})},redraw:function(){var b=this.$el;if(!b)throw Error("Old child not found on PostView.redraw");var a=this.childrenNode.children();this.render();this.updateDom(function(){b[0].parentNode.replaceChild(this.el,b[0]);this.childrenNode.append(a)},this)},processMentions:function(){this.contentNode.find("[data-dsq-mention]").each(function(){$(this).addClass("mention")})},
attachChild:function(b){var a=b.model;a.created||!a.id||a.get("isImmediateReply")?this.childrenNode.prepend(b.el):this.childrenNode.append(b.el)},drawReply:function(){this.reply&&(this.reply.render(),this.updateDom(function(){var b=this.childrenNode[0];b.insertBefore(this.reply.el,b.firstChild);this.reply.focus()},this))},toggleEdit:function(){this.edit?(this.edit.remove(),this.edit=null,this.messageNode.show()):(this.edit=new N({post:this.model}),this.edit.render(),this.edit.on("submitted",this.toggleEdit,
this),this.expandMessage(!0),this.updateDom(function(){var b=this.messageNode;b[0].parentNode.insertBefore(this.edit.el,b[0]);b.hide();this.edit.resize();(b=j.getInstance())&&b.scrollToPost(this.model.id)},this))},removeAsDeleted:function(){this.redraw()},bindDomEvents:function(){var b=this;b.delegateActions(b.contentNode,{upvote:function(){b.handleVote(1)},downvote:function(){b.handleVote(-1)},reply:"handleReply",flag:"handleFlag",edit:"handleEdit","delete":"handleDelete",spam:"handleSpam",blacklist:"handleBlacklist",
collapse:"handleCollapse",reveal:"handleReveal","share:twitter":"_onShare","share:facebook":"_onShare","post-expand":f(b.expandMessage)});var a=b.$el.find(".hovercard");if(a.length)b.profileCard=F.create({session:b.session,user:b.model.author,targetElement:a})},_onShare:function(b){if(b=g(b.target,"share"))k.trigger("uiAction:postShare",b),this.share(b)},_shareUrl:function(){return this.thread.url()+"#comment-"+this.model.id},handleBlacklist:function(){if(!this.blacklist){var b=this.blacklist=new X({model:this.model});
b.render();b.on("success cancel",function(){this.blacklist.remove();this.blacklist=null},this);this.updateDom(function(){this.contentNode.find("[data-role=blacklist-form]").first().append(b.el)},this)}},handleCollapse:function(){this.updateDom(function(){this.$el.toggleClass("collapsed");this.manageMessageHeight()},this)},handleVote:function(b){b===1?k.trigger("uiAction:postUpvote"):b===-1&&k.trigger("uiAction:postDownvote");var a=this.model.get("userScore")===b;this.model.vote(a?0:b);var c=this.contentNode.find("[data-role=voting]");
c.removeClass("upvoted").removeClass("downvoted");a||(b>0?c.addClass("upvoted"):b<0&&c.addClass("downvoted"))},remove:function(){this.model.off(null,null,this);this.session.off(null,null,this);Backbone.View.prototype.remove.call(this)},getReplyView:function(){if(this.reply)return this.reply;this.reply=new x({parentView:this,parent:this.model,thread:this.thread,session:this.options.session});this.drawReply();return this.reply},handleReply:function(){this.reply?this.getReplyView().toggle():this.getReplyView()},
handleFlag:function(){window.confirm("Are you sure you want to flag this comment?")&&this.model.report()},handleEdit:function(){this.toggleEdit()},handleDelete:function(){this.model.destroy()},handleSpam:function(){this.model.spam()},handleReveal:function(){this.model.set("isMinimized",!1);this.redraw()}});_.extend(H.prototype,r);var O=n.extend({render:function(){var b=this;b.setElement($(DISQUS.renderBlock("captcha")));b.$el.on("submit",function(a){a.preventDefault();b.trigger("submitted")})},start:function(){function b(){a.updateDom(function(){Recaptcha.create("6LdKMrwSAAAAAPPLVhQE9LPRW4LUSZb810_iaa8u",
a.el,{theme:"custom",custom_theme_widget:"recaptcha_widget"});a.$el.show()})}var a=this;typeof Recaptcha==="undefined"?DISQUS.require("//www.google.com/recaptcha/api/js/recaptcha_ajax.js",{},!1,b):b()},getChallenge:function(){return Recaptcha.get_challenge()},getResponse:function(){return Recaptcha.get_response()},reload:function(){Recaptcha.reload()}}),I=n.extend({initialize:function(b){this.session=b.session;this.showZero=b.showZero||!1;this.max=b.max;this.session.on("change:notificationCount",
this.render,this)},render:function(){var b=this.session.get("notificationCount")||0;this.max&&(b=Math.min(b,this.max));this.$el.html("<span>"+b+"</span>");b>0||this.showZero?this.$el.show():this.$el.hide();return this}}),E=Backbone.View.extend({__type__:"QueuedPostView",getDirection:function(b){if(this.offset&&this.dim){var a=b.pageOffset,c=this.offset.top+b.frameOffset.top;if(c+this.dim.height<a)return 1;if(c>a+b.height)return-1;return 0}},setCount:function(b){this.options.count=b},bindDrain:function(){var b=
_.bind(this.drainHandler,this);if(!this.clickEvent){if(this.$el.attr("data-action")=="load-queued-posts")this.$el.on("click",b);else this.$el.delegate("[data-action=load-queued-posts]","click",b);this.clickEvent=!0}},render:function(){var b=this;if(b.options.count===0)return void b.$el.hide();b.$el.html(DISQUS.renderBlock("realtimeCommentNotification",{comments:b.options.count}));b.bindDrain();j.getInstance().on("domReflow",_.throttle(function(){if(b.options.count!==0)this.offset=b.$el.offset(),this.dim=
b.$el.dim()},400),this);b.$el.show()},drainHandler:function(){this.model.queue.drain();this.setCount(this.model.queue.counters.comments);this.render()}}),R=E.extend({getDirection:function(b){if(this.options.postView.visible)return this.offset=this.options.postView.offset,this.dim=this.options.postView.dim,b=E.prototype.getDirection.call(this,b),delete this.offset,delete this.dim,b},render:function(){var b=this,a=b.options.postView;DISQUS.log("Model:",b.model.id);b.options.count===0?(b.$el.hide(),
a.trackPosition=!1):(a.trackPosition=!0,b.$el.html(DISQUS.renderBlock("realtimeReplyNotification",{replies:b.options.count})),b.bindDrain(),b.$el.show(),_.delay(function(){b.$el.addClass("reveal")},13))},drainHandler:function(){var b=this.model.id,a=this.options.postView,c=this.options.thread.queue;c.drain(b);this.setCount(c.counters.replies[b]);a.trackPosition=!1;this.render()}}),W=Backbone.View.extend({render:function(){var b=this.model.usersTyping.count(),a=this.options.parentView.reply;a&&a.isOpen()&&
(b-=1);if(b<=0)return void this.$el.hide();b==1?this.$el.html("One other user is typing&hellip;"):this.$el.html(b+" other users are typing&hellip;");this.$el.show()}}),Y=n.extend({tagName:"ul",className:"loading",initialize:function(b){this.collection.on("reset",this.render,this);this.session=b.session},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(b){this.$el.append(DISQUS.renderBlock("activityItem",{activity:b.toJSON(),
session:this.session?this.session.toJSON():null}))},this);this.trigger("render")},this);return this}}),T=n.extend({events:{"click [data-action=network]":"showNetwork","click [data-action=notifications]":"showNotifications"},initialize:function(b){this.network=new Z;this.notifications=new aa({notifications:b.session.notifications});this.notificationCount=new I({session:b.session,showZero:!0});this._views={network:this.network,notifications:this.notifications};this.network.on("render:activity",_.bind(this.trigger,
this,"render:all"))},render:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("dashboard"))},this);this._tabs={network:this.$el.find("[data-role=network-tab]"),notifications:this.$el.find("[data-role=notifications-tab]")};this.network.setElement(this.$el.find("[data-role=network]"));this.notifications.setElement(this.$el.find("[data-role=notifications]"));this.notificationCount.setElement(this.$el.find("[data-role=notification-count]"));this.network.render();this.notifications.render();
this.notificationCount.render()},show:function(){this.setActiveTab("notifications")},setActiveTab:function(b){var a=j.getInstance();a.freeze(!0);_.chain(this._tabs).invoke("removeClass","active");this._tabs[b].addClass("active");_.chain(this._views).pluck("$el").invoke("hide");var c=this._views[b];this.updateDom(function(){c.$el.show();a.freeze(!1)},this);c.show&&c.show()},showNetwork:f(function(){this.setActiveTab("network")}),showNotifications:f(function(){this.setActiveTab("notifications")})}),
ba=n.extend({events:{"click [data-action=more]":f(function(){this.trigger("fire")})},setBusy:function(){this.$el.find("[data-action=more]").addClass("busy").removeAttr("disabled")},setReady:function(){this.$el.find("[data-action=more]").removeClass("busy").removeAttr("disabled");this.updateDom(function(){var b=this.collection.cursor;b&&b.hasNext?this.$el.show():this.$el.hide()},this)}}),aa=n.extend({initialize:function(b){this.notifications=b.notifications;this.notifications.on("reset",this.resetNotifications,
this);this.notifications.on("add:many",this.addNotifications,this);this.notifications.on("reset add:many",this.markNotificationsAsRead,this);this._fetched=!1;this.moreButton=new ba({collection:this.notifications});this.moreButton.on("fire",this.loadMore,this)},render:function(){return this.renderLayout()},renderLayout:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("notifications"));this.moreButton.setElement(this.$el.find("[data-role=more-notifications]"));this.$el.addClass("loading")},
this);return this},resetNotifications:function(b){var a=this.$el.find("[data-role=no-notifications]");a.hide();this.$el.removeClass("loading");b.size()===0?a.show():(a.hide(),this.addNotifications.apply(this,arguments))},addNotifications:_.decorate(Backbone.collectionAddNormalizer(m.NotificationCollection,c.Notification),function(b){var a=_.map(b,function(b){return $(DISQUS.renderBlock("notification",{notification:b.toJSON()}))[0]});this.updateDom(function(){this.$el.find("[data-role=entries]").append(a)},
this);this.moreButton.setReady();this.notifications.markRead();return this}),show:function(){if(!this._fetched)this.notifications.fetch({reset:!0}),this._fetched=!0},loadMore:function(){this.moreButton.setBusy();this.notifications.more()}}),Z=n.extend({initialize:function(){this.posts=new m.PostActivityCollection;this.posts.on("reset",this.resetActivity,this);this.posts.on("add:many",this.addActivity,this);this._fetched=!1;this.moreButton=new ba({collection:this.posts});this.moreButton.on("fire",
this.loadMore,this)},render:function(){return this.renderLayout()},renderLayout:function(){this.updateDom(function(){this.$el.html(DISQUS.renderBlock("networkActivity"));this.moreButton.setElement(this.$el.find("[data-role=more-activity]"));this.$el.addClass("loading")},this);return this},resetActivity:function(b){var a=this.$el.find("[data-role=no-activity]");a.hide();this.$el.removeClass("loading");b.size()===0?a.show():(a.hide(),this.addActivity.apply(this,arguments))},addActivity:_.decorate(Backbone.collectionAddNormalizer(m.PostActivityCollection,
c.Post),function(b){var a=new Backbone.Collection;_.each(b,function(b){var d=a.get(b.get("thread").id)||new c.Thread(_.extend(b.get("thread"),{forum:b.get("forum")}));d.posts.add(b);a.add(d)});var d=a.map(function(b){var a=$(DISQUS.renderBlock("networkActivityThreadEntry",{thread:b.toJSON()})),b=b.posts.map(function(b){return $(DISQUS.renderBlock("networkActivityPostEntry",{post:b.toJSON()}))[0]});a.find("[data-role=posts]").append(b);return a[0]});this.updateDom(function(){this.$el.find("[data-role=entries]").append(d);
this.trigger("render:activity")},this);this.moreButton.setReady();return this}),show:function(){if(!this._fetched)this.posts.fetch({reset:!0}),this._fetched=!0},loadMore:function(){this.moreButton.setBusy();this.posts.more()}}),ca=n.extend({tagName:"ol",className:"loading",initialize:function(){this.collection.on("reset",function(){this.updateDom(this.render,this)},this)},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(b){var a=
DISQUS.assureOffset(b.get("createdAt"));this.$el.append(DISQUS.renderBlock("topThread",{id:b.id,title:b.get("title"),url:b.get("link"),numPosts:b.get("postsInInterval"),numLikes:b.get("likes"),timeAgo:moment(a,DISQUS.ISO_8601).fromNow()}))},this);this.trigger("render")},this);this.attachPosts();return this},attachPosts:function(){this.collection.each(function(b){this.renderPost(b)},this)},renderPost:function(b){var a=b.get("topPost");if(a){var c=_.escape(_.strip(a.message)),c=_.truncate(c,160,"&hellip;"),
d=DISQUS.renderBlock("topThreadPost",{message:c,author:a.author});this.updateDom(function(){this.$el.find("[data-role=thread-"+b.id+"] [data-role=top-thread-post]").html(d)},this)}}}),da=n.extend({tagName:"ol",className:"loading",initialize:function(){this.collection.on("reset",function(){k.thread.users.add(this.collection.models,{merge:!0});this.updateDom(this.render,this)},this)},render:function(){this.updateDom(function(){this.$el.removeClass("loading");this.$el.empty();this.collection.each(function(b){this.$el.append(DISQUS.renderBlock("topUser",
{user:b.toJSON()}))},this);this.trigger("render")},this);return this}}),U=Backbone.View.extend({initialize:function(b){var a=this;a.forum=b.forum;a.topThreads=new ca({id:"top-threads",collection:new m.TopThreadCollection(null,{forum:a.forum.id,limit:10})});a.topUsers=new da({id:"top-users",collection:new m.TopUserCollection(null,{forum:a.forum.id,limit:20,discardLowRep:k.switches.enabled("next_discard_low_rep")})});Backbone.when([a.topUsers,"render"],[a.topThreads,"render"]).then(function(){a.isRendered=
!0;a.trigger("render:all")});a.fetched=!1;a.render()},render:function(){this.$el.html(DISQUS.renderBlock("community",{forum:this.forum.toJSON()}));this.$el.find("[data-role=top-threads]").append(this.topThreads.el);this.$el.find("[data-role=top-users]").append(this.topUsers.el);return this},show:function(){if(!this.fetched)this.topThreads.collection.fetch({reset:!0}),this.topUsers.collection.fetch({reset:!0}),this.fetched=!0}}),K=n.extend({initialize:function(b){this.$el.addClass("loading");this.thread=
b.thread;this.session=b.session;this.bufferOutput=[];this.collection.on("add reset",this.onCollectionChange,this);this.renderBuffer=_.debounce(this.renderBuffer,K.renderDebounceInterval)},onCollectionChange:_.decorate(Backbone.collectionAddNormalizer(Backbone.Collection,Backbone.Model),function(b){this.bufferOutput=this.bufferOutput.concat(b.map(this.getReactionDom,this));this.renderBuffer()}),renderBuffer:function(){var b=this;b.updateDom(function(){b.$el.removeClass("loading");b.$el.append(b.bufferOutput);
b.bufferOutput=[];b.isRendered=!0;b.trigger("render:all")})},getReactionDom:function(b){b=new ea({model:b,thread:this.thread,session:this.session});b.render();return b.el},show:function(){this.collection.length>0||this.collection.fetch({reset:!0})}},{renderDebounceInterval:70}),r={toggleFollow:f(function(){this.user.get("isFollowing")?this.user.unfollow():(this.user.follow(),k.trigger("uiAction:followUser"))})},L=Backbone.View.extend({events:{"click [data-action=close]":"close","click [data-action=toggleFollow]":"toggleFollow"},
initialize:function(b){var a=this;a.user=b.user;a.session=b.session;a.user.get("numFollowers")===null&&a.user.fetch({success:function(){a.updateStats()}});a.user.on("change",a.updateStats,a);a.user.on("change:connections",a.updateConnections,a);a.user.on("change:isFollowing",a.updateActions,a);a.activity=new Y({id:"activity",collection:new m.ActivityCollection(null,{user:a.user,include:"user"}),session:a.session});a.activity.on("render",function(){a.isRendered=!0;a.trigger("render:all")});a.render()},
updateStats:function(){this.$el.find("[data-role=profile-stats]").html(DISQUS.renderBlock("profileStats",{user:this.user.toJSON()}))},updateActions:function(){this.$el.find("[data-role=actions]").html(DISQUS.renderBlock("profileActions",{user:this.user.toJSON(),sessionId:this.session.user.id}))},updateConnections:function(){this.$el.find("[data-role=connections]").html(DISQUS.renderBlock("profileConnections",{user:this.user.toJSON()}))},close:f(function(){this.trigger("close")}),render:function(){this.$el.empty();
this.$el.append(DISQUS.renderBlock("profile",{user:this.user.toJSON(),sessionId:this.session.user.id}));this.$el.find("[data-role=user-activity]").append(this.activity.el)},show:function(){this.activity.collection.fetch({reset:!0})}});_.extend(L.prototype,r);var s=n.extend({initialize:function(){this._id=_.uniqueId();this._rendered=!1;this._hoverState="out";this._leaveTimeout=this._enterTimeout=null;s.open={}},bindEvents:function(){var b=this;b.$el.on("mouseover",function(){b.enter()});b.$el.on("mouseout",
function(){b.leave()})},target:function(b){var a=this;b.on("mouseover",function(){a.enter(b)});b.on("mouseout",function(){a.leave()})},enter:function(a){var c=this;if(a)this.$target=a;c._leaveTimeout&&clearTimeout(c._leaveTimeout);if(c._hoverState!=="in")c._hoverState="in",c._enterTimeout=_.delay(function(){c._hoverState==="in"&&c.show();c._enterTimeout=null},s.DELAY_ENTER),s.open[this.uid]=this},leave:function(){var a=this;a._enterTimeout&&clearTimeout(a._enterTimeout);if(a._hoverState!=="out")a._hoverState=
"out",a._leaveTimeout=_.delay(function(){a._hoverState==="out"&&a.hide();a._leaveTimeout=null},s.DELAY_LEAVE),s.open[this.uid]&&delete s.open[this.uid]},show:function(){if(!this._rendered)this._rendered=!0,this.render();this.$target.append(this.el)},hide:function(){this.$el.remove()}},{open:{},instances:{},DELAY_ENTER:350,DELAY_LEAVE:175,exitAll:function(){_.invoke(s.open,"leave")},create:function(a,c,d,e){var f=s.instances[d];f||(s.instances[d]=f={});d=f[a];d||(d=new e(c),f[a]=d);d.target(c.targetElement);
return d}});(function(){$(document).on("mouseout",_.debounce(function(a){a=a.relatedTarget||a.toElement;(!a||a.nodeName==="HTML")&&s.exitAll()}),10)})();var F=s.extend({events:{"click [data-action=toggleFollow]":"toggleFollow"},initialize:function(a){var c=this;s.prototype.initialize.call(c,a);c.session=a.session;c.user=a.user;c.user.on("change:numPosts change:numLikesReceived",_.debounce(function(){c.updateCounters()}));c.user.on("change:isFollowing",function(){c.updateActions()});c.session.on("change:id",
function(){c._rendered&&c.render()})},render:function(){var a=this.user.toJSON();if(a.about)a.about=_.truncate(a.about,80,"...");this.setElement($(DISQUS.renderBlock("hovercard",{user:a,sessionId:this.session.user.id})));this.bindEvents()},updateCounters:function(){var a=this.$el.find("[data-role=counters]");this.updateDom(function(){a.html(DISQUS.renderBlock("hovercardCounters",{user:this.user.toJSON(),sessionId:this.session.user.id}))},this)},updateActions:function(){var a=this.$el.find("[data-role=actions]");
this.updateDom(function(){a.html(DISQUS.renderBlock("hovercardActions",{user:this.user.toJSON(),sessionId:this.session.user.id}))},this)},show:function(){this.user.get("numLikesReceived")===null&&this.user.fetch();s.prototype.show.call(this)}},{create:function(a){return s.create(a.user.id,a,"ProfileCard",F)}});_.extend(F.prototype,r);var M=s.extend({initialize:function(a){s.prototype.initialize.call(this,a);this.post=a.post},render:function(){var a=this.post.toJSON();a.excerpt=_.truncate(_.escape(_.strip(a.message),
40,"..."));this.setElement($(DISQUS.renderBlock("contextCard",{post:a})));this.bindEvents()}},{create:function(a){return s.create(a.post.id,a,"ContextCard",M)}}),ea=n.extend({events:{"click [data-action=remove]":"destroyReaction"},initialize:function(a){this.thread=a.thread;this.session=a.session;this.session.on("change:id",this.renderMenu,this)},render:function(){this.setElement($(DISQUS.renderBlock("reaction",{reaction:this.model.toJSON(),thread:this.thread.toJSON()})))},renderMenu:function(){var a=
this.$el.find("[data-role=menu]"),c=DISQUS.renderBlock("reactionMenu",{thread:this.session.toJSON().thread});this.updateDom(function(){a.html(c)},this)},destroyReaction:function(a){a&&a.preventDefault&&a.preventDefault();this.model.destroy();this.updateDom(function(){this.remove()},this)}}),P=n.extend({events:{"click [data-action=dismiss]":"dismiss"},initialize:function(a){_.extend(this,a)},render:function(){this.setElement($(DISQUS.renderBlock("alert",{message:this.message,type:this.type,safe:this.safe})));
return this},dismiss:function(a){a&&a.preventDefault&&a.preventDefault();this.remove();this.trigger("dismiss")}}),X=n.extend({events:{"click [data-action=cancel]":"cancel"},initialize:function(){var a=this;a.loading=!1;if(!a.model.get("ipAddress"))a.loading=!0,a.model.on("change:ipAddress",function C(){a.model.off("change:ipAddress",C);a.loading=!1;a.redraw()}),a.model.fetch()},render:function(){var a=this;a.setElement($(DISQUS.renderBlock("blacklist",{loading:this.loading,post:a.model.toJSON()})));
a.$el.on("submit",function(c){c&&c.preventDefault()&&c.preventDefault();a.submit()});return a},redraw:function(){var a=this.el.parentNode;a&&(this.render(),this.updateDom(function(){$(a).empty().append(this.el)},this))},cancel:function(a){a&&a.preventDefault()&&a.preventDefault();this.trigger("cancel")},submit:function(){var a={},c=this;c.$el.find("input").each(function(){if(this.checked)a[this.name]=this.value});if(!_.isEmpty(a))a.forum=c.model.get("forum"),DISQUS.api.call("blacklists/add.json",
{method:"POST",data:a,success:function(){c.trigger("success")}})}}),D=n.extend({events:{keyup:"handleKeychange",paste:"handleKeychange"},render:function(){this.el.tagName==="TEXTAREA"&&this.$el.autoresize({maxHeight:350});this.$el.on("resize",_.debounce(_.bind(this.updateDom,this,function(){}),300));return this},resize:function(){this.$el.trigger("paste")},get:function(){return this.$el.val()},set:function(a){this.$el.val(a)},clear:function(){this.set("")},focus:function(){this.el.focus()},handleKeychange:function(){this.trigger("keychange")}}),
y=D.extend({events:{keyup:"handleKeychange",paste:"handleKeychange"},initialize:function(a){a=a||{};this.thread=a.thread;this.mentionsCache=new m.UserCollection;this.suggestions=new fa({thread:a.thread,mentions:this.mentionsCache});this.placeholder="";this.suggestions.on("select",this.insertMention,this);this.reset()},reset:function(){this.anchorOffset=this.anchorNode=null;this.suggestions.clear()},handleKeychange:function(){this.trigger("keychange");this.$el.trigger("resize")},render:function(){var a=
this.el.getAttribute("placeholder"),c=this.el.value,d=document.createElement("div");_.extend(d,{className:"textarea",contentEditable:!0,tabIndex:this.el.tabIndex});d.setAttribute("role","textbox");d.setAttribute("aria-multiline","true");d.style.overflow="auto";d.style.maxHeight="350px";var e=this.el.parentNode;e.replaceChild(d,this.el);this.setElement(d);this.bindKeyEvents();e.appendChild(this.suggestions.el);this.content=new Editable(this.el,!0,{getHtmlElements:_.bind(this.getHtmlElements,this)});
this.set(c);D.prototype.render.call(this);if(a)this.placeholder='<span class="placeholder">'+a+"</span>",this.content.text()||this.$el.html(this.placeholder),this.$el.on("focus focusin",_.debounce(_.bind(function(){this.isPlaceholder()&&this.set("");this.el.focus()},this)),50),this.$el.on("blur",_.bind(function(){this.content.text()===""&&this.setPlaceholder()},this));return this},getHtmlElements:function(a){if(!a)return a;var c=[a],a=this.getMentionNodes(a);_.each(a,function(a,b){for(var d=0;d<c.length;d++){var e=
c[d],f=d,g;if(_.isString(e)){for(;(g=e.indexOf(b))>-1;)g>0&&c.splice(d++,0,e.substring(0,g)),c.splice(d++,0,a.cloneNode(!0)),e=e.substring(g+b.length);e&&e!==c[f]&&c.splice(d++,0,e);f!==d&&c.splice(d,1)}}});return c=_.map(c,function(a){return _.isString(a)?document.createTextNode(a):a})},getMentionNodes:function(a){var c=y.MENTIONS_RE_GROUPED,d={};c.lastIndex=0;for(var e=c.exec(a);e;){var f=e[1],g=this.thread.users.find(function(a){return a.get("username")===f||a.get("emailHash")===f});if(g){var i=
y.getMentionDom(g);d[e[0]]=i;this.updateCache(g,g.cid)}e=c.exec(a)}return d},isPlaceholder:function(){return this.$el.find(".placeholder").length!==0},setPlaceholder:function(){this.$el.html(this.placeholder)},bindKeyEvents:function(){this.$el.on("keydown",_.bind(function(a){switch(a.keyCode){case 9:this.suggestions.active&&(this.suggestions.select(),a.preventDefault(),a.stopPropagation());break;case 10:case 13:case 38:case 40:this.suggestions.active&&(a.preventDefault(),a.stopPropagation())}},this));
var a=_.throttle(_.bind(this.suggest,this),500);this.$el.on("keyup",_.bind(function(c){c.preventDefault();c.stopPropagation();this.checkExistingMentions();switch(c.keyCode){case 50:if(!c.shiftKey)break;this.start(c);break;case 10:case 13:this.suggestions.select();break;case 27:this.reset(c);break;case 38:this.suggestions.move("up");break;case 40:this.suggestions.move("down");break;default:a(c)}},this))},start:function(){this.reset();this.suggest()},suggest:function(){this.suggestions.suggest(this.parseSearchTerms())},
insertMention:function(a){var c=this.thread.users.get(a);this.selectSearchString(c);this.updateCache(c,a);this.content.insertHTML(y.getMentionHtml(c));a=this.$el.find("span[data-cid]");_.each(a,function(a){if(a.contentEditable!==!1)a.contentEditable=!1})},updateCache:function(a,c){this.mentionsCache.get(c)||this.mentionsCache.add(a)},selectSearchString:function(){this.content.selectNodeText(this.anchorNode,this.anchorOffset-1,this.anchorOffset+Editable.normalizeSpace(this.anchorNode.nodeValue.slice(this.anchorOffset)).toLowerCase().length)},
get:function(){var a=this,c=y.isMention;if(this.isPlaceholder())return"";return this.content.text(function(d){return c(d,!0)?a.mentionToText(d):null})},set:function(a){this.content.setText(a);this.resize()},clear:function(){D.prototype.clear.call(this);this.setPlaceholder();_.defer(function(a){a.updateDom(function(){a.el.blur();a.$el.trigger("blur")})},this)},parseSearchTerms:function(){var a=this.content.selectedTextNode(),c=a?a.nodeValue:"",d=Editable.normalizeSpace;if(c){var e=this.content.selectedTextNodeOffset(a),
f=Editable.normalizeSpace(c.slice(0,e).split("").reverse().join("")).indexOf("@");if(f===-1)return null;this.anchorNode=a;this.anchorOffset=e-f;if(a=d(c.slice(this.anchorOffset-1,e)).match(y.MENTIONS_RE))return a[0].slice(1).split(" ");if(f===0)return[""]}},checkExistingMentions:function(){var a=Editable.normalizeSpace,c=this.$el.find("span"),c=_.filter(c,y.isMention),d=this.mentionsCache,e={};_.each(c,function(c){var f=$(c).attr("data-cid"),h=_.reduce(this.content.getTextNodes(c),function(c,d){return c+
a(d.nodeValue)},""),g=d.get(f);g&&g.get("name")!==h?(this.mentionsCache.remove(g),this.content.removeNode(c),this.content.insertHTML(" "),this.reset()):e[f]=c},this);d.each(function(a){e[a.cid]||d.remove(a)})},mentionToText:function(a){var c=this.mentionsCache.get($(a).attr("data-cid")),a=a.innerText||a.textContent;c&&(a=c.get("username")||c.get("emailHash"));return["@",a,":disqus"].join("")}},{MENTIONS_RE:/@\w+\s?(?:\w+\s?){0,5}(?:\w+)?$/,MENTIONS_RE_GROUPED:/@([\d\w]+)\s?(\:\s?(\w+))?/gi,isMention:function(a,
c){var d;do{d=$(a);if(d.hasClass("mention")&&d.attr("data-cid"))return!0;a=a.parentElement}while(c&&a);return!1},getMentionHtml:function(a){return'<span contenteditable="true"><span contenteditable="false" data-cid="'+a.cid+'" class="mention">'+(a.get("name")||a.get("username"))+"</span></span>&nbsp;"},getMentionDom:function(a){var c=document.createDocumentFragment(),d=document.createElement("span"),e=document.createElement("span"),f=document.createTextNode(a.get("name")||a.get("username"));d.setAttribute("contenteditable",
!0);e.setAttribute("contenteditable",!1);e.setAttribute("data-cid",a.cid);e.className="mention";e.appendChild(f);d.appendChild(e);c.appendChild(d);c.appendChild(document.createTextNode(" "));return c}}),fa=Backbone.View.extend({events:{"click li":"onclick"},initialize:function(a){this.active=!1;this.thread=a.thread;this.mentionsCache=a.mentions},suggest:function(a){a=this.findMatches(a);if(!a||!a.length)return void this.clear();this.active=!0;this.el.innerHTML=DISQUS.renderBlock("suggestions",{users:_.map(a,
function(a){return _.extend(a.toJSON(),{cid:a.cid})})});this.$el.find("li[data-cid]").first().addClass("active")},clear:function(){this.active=!1;this.el.innerHTML=""},onclick:function(a){this.select($(a.currentTarget).attr("data-cid"))},findMatches:function(a){if(a&&a.length){for(var c=RegExp(a.join(" ").replace(/[^\w\s]/,""),"i"),d=fa.MAX_SUGGESTIONS,e=this.thread.users,f=[],g=0,i,a=a.length===1&&a[0]===""?function(){return!0}:function(a){return c.test(a.get("name"))||c.test(i.get("username"))},
g=0;g<e.models.length&&f.length<d;g++)i=e.models[g],this.mentionsCache.get(i.cid)||a(i)&&f.push(i);return f}},select:function(a){this.active&&(a||(a=this.$el.find(".active").attr("data-cid")),this.trigger("select",a),this.clear())},move:function(a){if(this.active){var c=this.$el.find(".active"),a=c[a==="up"?"previous":"next"]();a.length&&a.attr("data-cid")&&(c.removeClass("active"),a.addClass("active"))}}},{MAX_SUGGESTIONS:5}),S=n.extend({tagName:"ul",className:"debug",initialize:function(a){this.values=
a},render:function(){this.$el.empty();_.each(this.values,function(a,c){var d=document.createElement("li");d.innerHTML="<strong>"+c+"</strong>: "+a;this.$el.append(d)},this);return this}}),V=Backbone.View.extend({events:{"click [data-nav]":"_navTo"},initialize:function(){this.prevDestination=this.activeNav()},_navTo:function(a){a.preventDefault();a=$(a.target);a=a.is("[data-nav]")?a:a.closest("[data-nav]");a=a.attr("data-nav");if(this.prevDestination==a)return!1;this.navTo(a)},navTo:function(a){this.prevDestination=
a;var c=this.$el.find("[data-nav="+a+"]").parent();c.siblings("li").removeClass("active");c.addClass("active");this.trigger("nav",a)},activeNav:function(){if(this.prevDestination!=null)return this.prevDestination;return this.$el.find(".active [data-nav]").attr("data-nav")},clear:function(){this.$el.find("li").removeClass("active");this.prevDestination=null}}),Q=Backbone.View.extend({events:{"click [rel=nofollow]":"sendLinkForInspection"},initialize:function(){this.link=null;this.busy=!1;this.timeoutId=
null;this.timeout=1E3;this.token=1;this.on("option.timeout",function(a){this.timeout=a})},setLink:function(a){this.link=a;this.$link=$(this.link)},onAffiliatorResponse:function(b){b=b||{};if(b.token==this.token){a.off("affiliateLink",this.onAffilatorResponse);if(b.url)this.link.href=b.url;this.undelegateEvents();this.$link.click()}},sendLinkForInspection:function(b){if(b.currentTarget===this.link)return void b.preventDefault();var c=b.which&&b.which===1||b.button===0;if(b.ctrlKey||b.metaKey||b.altKey||
b.shiftKey||!c)return!0;if(this.busy){a.off("affiliateLink");if(this.timeoutId&&window.clearTimeout)window.clearTimeout(this.timeoutId),this.timeoutId=null;this.token++}this.busy=!0;this.setLink(b.currentTarget);b.preventDefault();a.on("affiliateLink",this.onAffiliatorResponse,this);a.sendHostMessage("affiliateLink",{token:this.token,url:this.link.href});b=_.bind(function(a){this.onAffiliatorResponse({token:a})},this,this.token);this.timeoutId=_.delay(b,this.timeout)}});return{Lounge:j,LoungeSubView:n,
PostView:H,PostReplyView:x,PostEditView:N,UserMenuView:A,ThreadVotesView:u,ThreadSubscribeButton:z,ReactionView:ea,ReactionsCollectionView:K,QueuedPostView:E,QueuedReplyView:R,TypingUserView:W,CommunityView:U,TopThreadCollectionView:ca,TopUserCollectionView:da,DashboardView:T,NotificationCollectionView:aa,NotificationCountView:I,UserActivityCollectionView:Y,NetworkActivityCollectionView:Z,ProfileView:L,HoverCard:s,ProfileCard:F,ContextCard:M,CaptchaView:O,OutboundLinkHandler:Q,AlertView:P,BlacklistView:X,
ContentEditableView:y,DebugInfoView:S}});var _comscore,_gaq;
(function(d){var f="",f="UA-1410476-6",g=d.getElementsByTagName("script")[0],c=g.parentNode,m=d.location.protocol=="https:";_comscore=_comscore||[];_comscore.push({c1:"7",c2:"10137436",c3:"1"});var e=document.createElement("script");e.async=!0;e.src=(m?"https://sb":"http://b")+".scorecardresearch.com/beacon.js";c.insertBefore(e,g);_gaq=_gaq||[];_gaq.push(["_setAccount",f]);_gaq.push(["_setDomainName",".disqus.com"]);d=d.createElement("script");d.type="text/javascript";d.async=!0;d.src=(m?"https://ssl":
"http://www")+".google-analytics.com/ga.js";c.insertBefore(d,g)})(document);
(function(){DISQUS.log=function(){var d=DISQUS.next.views.Lounge.getInstance();window.console&&d&&d.switches&&d.switches.enabled("next_logging")&&(window.console.log.apply?window.console.log.apply(window.console,arguments):window.console.log(Array.prototype.slice.call(arguments,0).join(" ")))};DISQUS.logError=function(){var d=DISQUS.next.views.Lounge.getInstance(),f=Array.prototype.slice.call(arguments,0);DISQUS.log.apply(DISQUS,f);d.switches&&d.switches.enabled("next_raven")&&d.states.ravenConfigured&&
Raven.captureMessage({name:"DISQUS.logError",message:f.join(" ")})};$(document).ready(function(){function d(){$(".dropdown").removeClass("open")}$("html").on("click",d);$("body").delegate("[data-toggle]","click",function(f){f.stopPropagation();f.preventDefault();var f=$(f.currentTarget),f=f.closest("."+f.attr("data-toggle")),g=f.attr("data-dropdown")!="disabled"&&!f.hasClass("open");f.attr("data-dropdown","enabled");d();g&&f.addClass("open")});DISQUS.Bus.on("window.click",d)})})();